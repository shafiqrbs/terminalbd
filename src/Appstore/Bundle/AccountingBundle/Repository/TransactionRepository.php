<?php

namespace Appstore\Bundle\AccountingBundle\Repository;
use Appstore\Bundle\AccountingBundle\Entity\AccountBalanceTransfer;
use Appstore\Bundle\AccountingBundle\Entity\AccountBank;
use Appstore\Bundle\AccountingBundle\Entity\AccountJournal;
use Appstore\Bundle\AccountingBundle\Entity\AccountOnlineOrder;
use Appstore\Bundle\AccountingBundle\Entity\AccountPurchaseCommission;
use Appstore\Bundle\AccountingBundle\Entity\AccountPurchaseReturn;
use Appstore\Bundle\AccountingBundle\Entity\AccountSales;
use Appstore\Bundle\AccountingBundle\Entity\AccountSalesAdjustment;
use Appstore\Bundle\AccountingBundle\Entity\AccountSalesReturn;
use Appstore\Bundle\AccountingBundle\Entity\Expenditure;
use Appstore\Bundle\AccountingBundle\Entity\PaymentSalary;
use Appstore\Bundle\AccountingBundle\Entity\PettyCash;
use Appstore\Bundle\AccountingBundle\Entity\Transaction;
use Appstore\Bundle\AssetsBundle\Entity\PurchaseItem;
use Appstore\Bundle\DmsBundle\Entity\DmsTreatmentPlan;
use Appstore\Bundle\HospitalBundle\Entity\Invoice;
use Appstore\Bundle\HospitalBundle\Entity\InvoiceTransaction;
use Appstore\Bundle\HotelBundle\Entity\HotelInvoiceTransaction;
use Appstore\Bundle\InventoryBundle\Entity\Damage;
use Appstore\Bundle\InventoryBundle\Entity\Purchase;
use Appstore\Bundle\InventoryBundle\Entity\PurchaseReturn;
use Appstore\Bundle\InventoryBundle\Entity\Sales;
use Appstore\Bundle\InventoryBundle\Entity\SalesReturn;
use Doctrine\ORM\EntityRepository;
use Appstore\Bundle\AccountingBundle\Entity\AccountPurchase;
use Setting\Bundle\ToolBundle\Entity\GlobalOption;
use Symfony\Component\Debug\Debug;
use Symfony\Component\Validator\Constraints\DateTime;

/**
 * TransactionRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class TransactionRepository extends EntityRepository
{

    /**
     * @param $qb
     * @param $data
     */

    protected function handleSearchBetween($qb,$data)
    {

        if(empty($data)){
            $datetime = new \DateTime("now");
            $startDate = $datetime->format('Y-m-d 00:00:00');
            $endDate = $datetime->format('Y-m-d 23:59:59');
        }elseif(!empty($data['startDate']) and !empty($data['endDate'])){
            $start = new \DateTime($data['startDate']);
            $startDate = $start->format('Y-m-d 00:00:00');
            $end = new \DateTime($data['endDate']);
            $endDate = $end->format('Y-m-d 23:59:59');
        }
        if (!empty($startDate) ) {
            $qb->andWhere("ex.updated >= :startDate");
            $qb->setParameter('startDate', $startDate);
        }
        if (!empty($endDate)) {
            $qb->andWhere("ex.updated <= :endDate");
            $qb->setParameter('endDate', $endDate);
        }
    }

    public function removeTransaction($option,$process)
    {
	    $transaction = $this->_em->createQuery("DELETE AccountingBundle:Transaction e WHERE e.globalOption = {$option->getId()} AND e.processHead ='{$process}'");
	    $transaction->execute();
    }

	public function finalTransaction(GlobalOption $globalOption)
	{

		$qb = $this->createQueryBuilder('e');
		$qb->join('e.accountHead','a');
		$qb->select('a.name as name , e.processHead as processHead , sum(e.debit) as debit , sum(e.credit) as credit');
		$qb->where("e.globalOption = :globalOption");
		$qb->setParameter('globalOption',$globalOption->getId());
		$qb->groupBy('e.accountHead');
		$qb->orderBy('e.accountHead','ASC');
		$result = $qb->getQuery();
		$res = $result->getArrayResult();
		return $res;
	}



	public function transactionOverview($globalOption,$accountHead = 0)
    {

        $qb = $this->createQueryBuilder('e');
        $qb->select('sum(e.debit) as debit , sum(e.credit) as credit');
        $qb->where("e.globalOption = :globalOption");
        $qb->setParameter('globalOption',$globalOption);
        if(!empty($accountHead)){
            $qb->andWhere("e.accountHead = :head");
            $qb->setParameter('head',$accountHead);
        }
        $result = $qb->getQuery();
        $res = $result->getOneOrNullResult();
        return $res;
    }

    public function getGroupByAccountHead($globalOption){

        $qb = $this->createQueryBuilder('e');
        $qb->join('e.accountHead','accountHead');
        $qb->join('accountHead.parent','parent');
        $qb->select('sum(e.amount) as amount, sum(e.debit) as debit , sum(e.credit) as credit, accountHead.name as name , parent.name as parentName,parent.id as parentId, accountHead.id, accountHead.toIncrease, accountHead.code as code');
        $qb->where("e.globalOption = :globalOption");
        $qb->setParameter('globalOption', $globalOption->getId());
        $qb->groupBy('e.accountHead');
        $qb->orderBy('parent.name','ASC');
        $result = $qb->getQuery()->getArrayResult();
        return $result;
    }

    public function parentsAccountHead($globalOption,$parent,$data){

        $qb = $this->_em->createQueryBuilder();
        $qb->select('sum(ex.amount) as amount, accountHead.name as name , accountHead.id, accountHead.toIncrease, accountHead.code');
        $qb->from('AccountingBundle:Transaction','ex');
        $qb->innerJoin('ex.accountHead','accountHead');
        $qb->where('ex.globalOption = :globalOption')->setParameter('globalOption', $globalOption->getId());
        $qb->andWhere("accountHead.parent IN(:parent)")->setParameter('parent', $parent);
        $this->handleSearchBetween($qb,$data);
        $qb->groupBy('ex.accountHead');
        $qb->orderBy('ex.accountHead','ASC');
        $result = $qb->getQuery()->getResult();
        return $result;
    }


    public function specificParentAccountHead($globalOption,$parent){

        $datetime = new \DateTime("now");
        $today_startdatetime = $datetime->format('Y-m-d 00:00:00');
        $today_enddatetime = $datetime->format('Y-m-d 23:59:59');

        $qb = $this->_em->createQueryBuilder();
        $qb->select('sum(e.amount) as amount, accountHead.name as name , accountHead.id, accountHead.toIncrease, accountHead.code');
        $qb->from('AccountingBundle:Transaction','e');
        $qb->innerJoin('e.accountHead','accountHead');
        $qb->where('e.globalOption = :globalOption')
            ->andWhere("accountHead.parent = :parent")
            ->andWhere('e.updated >= :today_startdatetime')
            ->andWhere('e.updated <= :today_enddatetime');
        $qb->setParameter('globalOption', $globalOption->getId())
            ->setParameter('parent', $parent)
            ->setParameter('today_startdatetime', $today_startdatetime)
            ->setParameter('today_enddatetime', $today_enddatetime);
        $qb->groupBy('e.accountHead');
        $qb->orderBy('e.accountHead','ASC');
        $result = $qb->getQuery()->getResult();

        return $result;


    }

    public function specificAccountHead($globalOption,$accountHead){

        $datetime = new \DateTime("now");
        $today_startdatetime = $datetime->format('Y-m-d 00:00:00');
        $today_enddatetime = $datetime->format('Y-m-d 23:59:59');

        $qb = $this->_em->createQueryBuilder();
        $qb->select('e.amount as amount,e.debit as debit, e.credit as credit , e.updated,e.accountRefNo, e.processHead, e.toIncrease, e.content');
        $qb->from('AccountingBundle:Transaction','e');
        $qb->where('e.globalOption = :globalOption')
            ->andWhere("e.accountHead = :accountHead");
        $qb->setParameter('globalOption', $globalOption->getId())
            ->setParameter('accountHead', $accountHead);
        $qb->orderBy('e.updated','DESC');
        $result = $qb->getQuery()->getResult();

        return $result;

    }

    public function reportTransactionIncomeLoss($globalOption,$accountHeads,$data){

        $qb = $this->createQueryBuilder('ex');
        $qb->join('ex.accountHead','accountHead');
        $qb->select('SUM(ex.amount) as amount');
        $qb->where("accountHead.parent IN (:parent)");
        $qb->setParameter('parent', $accountHeads);
        $qb->andWhere('ex.globalOption = :globalOption');
        $qb->setParameter('globalOption', $globalOption);
        $this->handleSearchBetween($qb,$data);
        $res =  $qb->getQuery();
        $result = $res->getOneOrNullResult();
        return $result;

    }

    public function reportTransactionIncome($globalOption,$accountHeads,$data){

        $qb = $this->createQueryBuilder('ex');
        $qb->join('ex.accountHead','accountHead');
        $qb->select('sum(ex.amount) as amount, sum(ex.debit) as debit , sum(ex.credit) as credit, accountHead.name as name, accountHead.toIncrease as toIncrease');
        $qb->where("accountHead.parent IN (:parent)");
        $qb->setParameter('parent', $accountHeads);
        $qb->andWhere('ex.globalOption = :globalOption');
        $qb->setParameter('globalOption', $globalOption);
        $this->handleSearchBetween($qb,$data);
        $qb->groupBy('ex.accountHead');
        $res =  $qb->getQuery();
        $result = $res->getArrayResult();
        return $result;

    }

    public function reportDebitTransactionIncome($globalOption,$accountHeads,$data){

        $qb = $this->createQueryBuilder('ex');
        $qb->join('ex.accountHead','accountHead');
        $qb->select('sum(ex.amount) as amount');
        $qb->where("accountHead.id IN (:ids)");
        $qb->setParameter('ids', $accountHeads);
        $qb->andWhere('ex.globalOption = :globalOption');
        $qb->setParameter('globalOption', $globalOption);
        $this->handleSearchBetween($qb,$data);
        $qb->groupBy('ex.accountHead');
        $res =  $qb->getQuery();
        $result = $res->getOneOrNullResult();
        return $result['amount'];

    }

    public function reportTransactionVat($globalOption,$accountHeads,$data){

        $qb = $this->createQueryBuilder('ex');
        $qb->join('ex.accountHead','accountHead');
        $qb->select('sum(ex.credit) as salesVat');
        $qb->where("accountHead.id = :head");
        $qb->setParameter('head', 16);
        $qb->andWhere('ex.globalOption = :globalOption');
        $qb->setParameter('globalOption', $globalOption);
        $this->handleSearchBetween($qb,$data);
        $res =  $qb->getQuery();
        $result = $res->getOneOrNullResult();
        if($result){
            return $result['salesVat'];
        }
        return 0;

    }

    public function insertAccountJournalTransaction(AccountJournal $journal)
    {
        $this->insertAccountJournalDebitTransaction($journal);
        $this->insertAccountJournalCreditTransaction($journal);
    }

    public function insertAccountJournalDebitTransaction(AccountJournal $entity)
    {

        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setProcessHead('Journal');
        $transaction->setProcess($entity->getAccountHeadDebit()->getParent()->getName());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setUpdated($entity->getUpdated());
        $transaction->setAccountHead($entity->getAccountHeadDebit());
        $transaction->setAmount($entity->getAmount());
        $transaction->setDebit($entity->getAmount());

        /* Cash - Cash various */

        if (!empty($entity->getToUser()) and !empty($entity->getToUser()->getProfile()->getUserGroup()) and $entity->getTransactionType() == 'Credit'){
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertUserAccount($entity->getToUser()->getProfile());
            $transaction->setSubAccountHead($subAccount);
        }

        if($entity->getTransactionMethod()->getId() == 2 and $entity->getTransactionType() == 'Debit' ){

            /* Current Asset Bank Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($entity->getAccountBank());
            $transaction->setSubAccountHead($subAccount);

        }elseif($entity->getTransactionMethod()->getId() == 3 and $entity->getTransactionType() == 'Debit' ){

            /* Current Asset Mobile Account Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($entity->getAccountMobileBank());
            $transaction->setSubAccountHead($subAccount);

        }

        if(!empty($entity->getBranches())){
            $transaction->setBranches($entity->getBranches());
        }
        $this->_em->persist($transaction);
        $this->_em->flush();

        return $transaction;

    }

    public function insertAccountJournalCreditTransaction(AccountJournal $entity)
    {

        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setProcessHead('Journal');
        $transaction->setProcess($entity->getAccountHeadCredit()->getParent()->getName());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setUpdated($entity->getUpdated());
        $transaction->setAccountHead($entity->getAccountHeadCredit());
        $transaction->setAmount('-'.$entity->getAmount());
        $transaction->setCredit($entity->getAmount());

        /* Cash - Cash various */

        if (!empty($entity->getToUser()) and !empty($entity->getToUser()->getProfile()->getUserGroup()) and $entity->getTransactionType() == 'Debit'){
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertUserAccount($entity->getToUser()->getprofile());
            $transaction->setSubAccountHead($subAccount);
        }

        if($entity->getTransactionMethod()->getId() == 2 and $entity->getTransactionType() == 'Credit' ){

            /* Current Asset Bank Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($entity->getAccountBank());
            $transaction->setSubAccountHead($subAccount);

        }elseif($entity->getTransactionMethod()->getId() == 3 and $entity->getTransactionType() == 'Credit' ){

            /* Current Asset Mobile Account Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($entity->getAccountMobileBank());
            $transaction->setSubAccountHead($subAccount);

        }


        if(!empty($entity->getBranches())){
            $transaction->setBranches($entity->getBranches());
        }
        $this->_em->persist($transaction);
        $this->_em->flush();

        return $transaction;

    }

	public function insertAccountBalanceTransferTransaction(AccountBalanceTransfer $journal)
	{
		$this->insertAccountBalanceDebitTransaction($journal);
		$this->insertAccountBalanceCreditTransaction($journal);
	}

	public function insertAccountBalanceDebitTransaction(AccountBalanceTransfer $entity)
	{

		$transaction = new Transaction();
		$transaction->setGlobalOption($entity->getGlobalOption());
		$transaction->setProcessHead('Contra Account');
		$transaction->setProcess('Current Assets');
		$transaction->setAccountRefNo($entity->getAccountRefNo());
		$transaction->setUpdated($entity->getUpdated());
        /* Cash - Cash various */
        if($entity->getToTransactionMethod()->getId() == 2 ){
            /* Current Asset Bank Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($entity->getToAccountBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getToTransactionMethod()->getId() == 3 ){
            /* Current Asset Mobile Account Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($entity->getToAccountMobileBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getToTransactionMethod()->getId() == 1 ){
            /* Cash - Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
            $transaction->setProcess('Cash');
        }
		$transaction->setAmount($entity->getAmount());
		$transaction->setDebit($entity->getAmount());
		if(!empty($entity->getBranches())){
			$transaction->setBranches($entity->getBranches());
		}
		$this->_em->persist($transaction);
		$this->_em->flush();

		return $transaction;

	}

	public function insertAccountBalanceCreditTransaction(AccountBalanceTransfer $entity)
	{

		$transaction = new Transaction();
		$transaction->setGlobalOption($entity->getGlobalOption());
		$transaction->setProcessHead('Contra Account');
		$transaction->setProcess('Current Assets');
		$transaction->setAccountRefNo($entity->getAccountRefNo());
		$transaction->setUpdated($entity->getUpdated());
        /* Cash - Cash various */
        if($entity->getFromTransactionMethod()->getId() == 2 ){
            /* Current Asset Bank Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($entity->getFromAccountBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getFromTransactionMethod()->getId() == 3 ){
            /* Current Asset Mobile Account Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($entity->getFromAccountMobileBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getToTransactionMethod()->getId() == 1 ){
            /* Cash - Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
            $transaction->setProcess('Cash');
        }
		$transaction->setAmount('-'.$entity->getAmount());
		$transaction->setCredit($entity->getAmount());
		if(!empty($entity->getBranches())){
			$transaction->setBranches($entity->getBranches());
		}
		$this->_em->persist($transaction);
		$this->_em->flush();

		return $transaction;

	}

	public function purchaseTransaction(Purchase $purchase,$accountPurchase,$source='')
    {
        $this->insertInventoryAsset($purchase,$accountPurchase);
        $this->insertPurchaseCash($purchase,$accountPurchase);
        $this->insertPurchaseAccountPayable($purchase,$accountPurchase);
    }


    private function insertInventoryAsset($purchase,$accountPurchase)
    {

        $amount = $purchase->getTotalAmount();
        $transaction = new Transaction();
        $transaction->setGlobalOption($purchase->getInventoryConfig()->getGlobalOption());
        $transaction->setProcessHead('Purchase');
        $transaction->setProcess('Inventory Assets');
        $transaction->setAccountRefNo($accountPurchase->getAccountRefNo());
        $transaction->setUpdated($accountPurchase->getUpdated());
        /* Inventory Assets - Purchase Goods Received account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(6));
        $transaction->setAmount($amount);
        $transaction->setDebit($amount);
        $this->_em->persist($transaction);
        $this->_em->flush();


    }

    private function insertPurchaseCash(Purchase $purchase,AccountPurchase $accountPurchase)
    {

        $amount = $purchase->getPaymentAmount();
        if($amount > 0) {

            $transaction = new Transaction();
            $transaction->setGlobalOption($purchase->getInventoryConfig()->getGlobalOption());
            $transaction->setProcessHead('Purchase');
            $transaction->setProcess('Cash');
            $transaction->setAccountRefNo($accountPurchase->getAccountRefNo());
            $transaction->setUpdated($accountPurchase->getUpdated());

            /* Cash - Cash various */

            /* Cash - Cash various */
            if($purchase->getTransactionMethod()->getId() == 2 ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($purchase->getAccountBank());
                $transaction->setSubAccountHead($subAccount);
                $transaction->setProcess('Current Assets');
            }elseif($purchase->getTransactionMethod()->getId() == 3 ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($purchase->getAccountMobileBank());
                $transaction->setSubAccountHead($subAccount);
                $transaction->setProcess('Current Assets');
            }elseif($purchase->getTransactionMethod()->getId() == 1 ){
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }


            $transaction->setAmount('-' . $amount);
            $transaction->setCredit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }
    }

    private function insertPurchaseAccountPayable(Purchase $purchase, AccountPurchase $accountPurchase)
    {

        $amount = $purchase->getDueAmount();
        if($amount > 0){
            $transaction = new Transaction();
            $transaction->setGlobalOption($accountPurchase->getGlobalOption());
            $transaction->setProcessHead('Purchase');
            $transaction->setProcess('Current Liabilities');
            $transaction->setAccountRefNo($accountPurchase->getAccountRefNo());
            $transaction->setUpdated($accountPurchase->getUpdated());
            /* Current Liabilities-Purchase Account payable */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(13));
            $transaction->setAmount('-'.$amount);
            $transaction->setCredit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    public function insertVendorOpeningTransaction(AccountPurchase $entity)
    {

    	$transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('Opening Liabilities');
        $transaction->setUpdated($entity->getUpdated());
        $transaction->setProcess('Current Liabilities');
        /* Current Liabilities - Account Payable Payment */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(13));
        /* ==== Sub Account set ====*/
        if($entity->getGlobalOption()->getMainApp()->getSlug() == 'miss'){
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMedicineVendorAccount($entity->getMedicineVendor());
        }elseif ($entity->getGlobalOption()->getMainApp()->getSlug() == 'inventory'){
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertInventoryVendorAccount($entity->getVendor());
        }else{
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertVendorAccount($entity->getAccountVendor());
        }
        $transaction->setSubAccountHead($subAccount);
        $transaction->setAmount('-'.$entity->getPurchaseAmount());
        $transaction->setCredit($entity->getPurchaseAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();

	    $transaction = new Transaction();
	    $transaction->setGlobalOption($entity->getGlobalOption());
	    $transaction->setAccountRefNo($entity->getAccountRefNo());
	    $transaction->setProcessHead('Opening Liabilities');
	    $transaction->setUpdated($entity->getUpdated());
	    $transaction->setProcess('Inventory Assets');
	    /* Current Liabilities - Account Payable Payment */
	    $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(6));
        $transaction->setSubAccountHead($subAccount);
	    $transaction->setAmount($entity->getPurchaseAmount());
	    $transaction->setDebit($entity->getPurchaseAmount());
	    $this->_em->persist($transaction);
	    $this->_em->flush();

    }

    public function insertPurchaseVendorTransaction(AccountPurchase $entity)
    {
        $this->insertPurchaseCashCreditTransaction($entity);
        $this->insertPurchaseLiabilityDebitTransaction($entity);
    }

    public function insertPurchaseCashCreditTransaction(AccountPurchase $entity)
    {

        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('Purchase');
        $transaction->setUpdated($entity->getUpdated());

        /* Cash - Cash various */
        if($entity->getTransactionMethod()->getId() == 2 ){
            /* Current Asset Bank Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($entity->getAccountBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getTransactionMethod()->getId() == 3 ){
            /* Current Asset Mobile Account Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($entity->getAccountMobileBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getTransactionMethod()->getId() == 1 ){
            /* Cash - Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
            $transaction->setProcess('Cash');
        }
        if($entity->getGlobalOption()->getMainApp()->getSlug() == 'miss'){
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMedicineVendorAccount($entity->getMedicineVendor());
        }elseif ($entity->getGlobalOption()->getMainApp()->getSlug() == 'inventory'){
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertInventoryVendorAccount($entity->getVendor());
        }else{
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertVendorAccount($entity->getAccountVendor());
        }
        $transaction->setSubAccountHead($subAccount);
        $transaction->setAmount('-'.$entity->getPayment());
        $transaction->setCredit($entity->getPayment());
        $this->_em->persist($transaction);
        $this->_em->flush();
    }

    public function insertPurchaseLiabilityDebitTransaction(AccountPurchase $entity)
    {

        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('Purchase');
        $transaction->setUpdated($entity->getUpdated());
        $transaction->setProcess('Current Liabilities');
        /* Current Liabilities - Account Payable Payment */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(13));
        /* ==== Sub Account set ==== */
        if($entity->getGlobalOption()->getMainApp()->getSlug() == 'miss'){
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMedicineVendorAccount($entity->getMedicineVendor());
        }elseif ($entity->getGlobalOption()->getMainApp()->getSlug() == 'inventory'){
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertInventoryVendorAccount($entity->getVendor());
        }else{
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertVendorAccount($entity->getAccountVendor());
        }
        $transaction->setSubAccountHead($subAccount);
        $transaction->setAmount($entity->getPayment());
        $transaction->setDebit($entity->getPayment());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    public function purchaseReturnTransaction($entity,$accountPurchaseReturn)
    {

        $this->insertPurchaseReturn($entity,$accountPurchaseReturn);
        $this->insertPurchaseReturnAccountReceivable($entity,$accountPurchaseReturn);

    }

    private function insertPurchaseReturn(PurchaseReturn $entity,AccountPurchaseReturn $accountPurchaseReturn)
    {

        $transaction = new Transaction();
        $transaction->setGlobalOption($accountPurchaseReturn->getGlobalOption());
        $transaction->setAccountRefNo($accountPurchaseReturn->getAccountRefNo());
        $transaction->setProcessHead('PurchaseReturn');
        $transaction->setUpdated($entity->getUpdated());
        $transaction->setProcess('Goods');
        /* Inventory Assets-Purchase Return account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(34));
        $transaction->setAmount('-'.$entity->getTotal());
        $transaction->setCredit($entity->getTotal());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    private function insertPurchaseReturnAccountReceivable(PurchaseReturn $entity,AccountPurchaseReturn $accountPurchaseReturn)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($accountPurchaseReturn->getGlobalOption());
        $transaction->setAccountRefNo($accountPurchaseReturn->getAccountRefNo());
        $transaction->setProcessHead('PurchaseReturn');
        $transaction->setUpdated($entity->getUpdated());
        $transaction->setProcess('Cash');
        /* Assets Account - Account Cash */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
        $transaction->setAmount($entity->getTotal());
        $transaction->setDebit($entity->getTotal());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    public function salesTransaction($entity,$accountSales)
    {
        $this->insertSalesItem($entity,$accountSales);
        $this->insertSalesProfit($entity,$accountSales);
        $this->insertSalesCash($entity,$accountSales);
        $this->insertSalesAccountReceivable($entity,$accountSales);
        $this->insertSalesVatAccountPayable($entity,$accountSales);
    }

    public function resetSalesTransaction($option , $entity, $accountSales)
    {
	    $this->salesTransaction($entity,$accountSales);
    }

    private function insertSalesItem(Sales $entity , AccountSales $accountSales)
    {
        $amount =  $entity->getPurchasePrice();
        $transaction = new Transaction();
        $transaction->setGlobalOption($accountSales->getGlobalOption());
        if(!empty($accountSales->getBranches())){
            $transaction->setBranches($accountSales->getBranches());
        }
        $transaction->setAccountRefNo($accountSales->getAccountRefNo());
        $transaction->setProcessHead('Sales');
        $transaction->setProcess('Goods');
        /* Sales Revenue - Sales goods account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(6));
        $transaction->setAmount('-'.$amount);
        $transaction->setCredit($amount);
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    private function insertSalesProfit(Sales $entity , AccountSales $accountSales)
    {
        $amount =  $entity->getProfit();
        $transaction = new Transaction();
        $transaction->setGlobalOption($accountSales->getGlobalOption());
        if(!empty($accountSales->getBranches())){
            $transaction->setBranches($accountSales->getBranches());
        }
        $transaction->setAccountRefNo($accountSales->getAccountRefNo());
        $transaction->setProcessHead('Sales');
        $transaction->setProcess('Current Liabilities');
        /* Sales Revenue - Sales Profit */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(60));
        $transaction->setAmount('-'.$amount);
        $transaction->setCredit($amount);
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    private function insertSalesCash(Sales $entity , AccountSales $accountSales)
    {
        $amount = $entity->getPayment();
        if($amount > 0) {
            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setUpdated($entity->getUpdated());

            /* Cash - Cash various */
            if($accountSales->getTransactionMethod()->getId() == 2 ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                if($accountSales->getAccountBank()){
                    $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($accountSales->getAccountBank());
                    $transaction->setSubAccountHead($subAccount);
                }
                $transaction->setProcess('Current Assets');
            }elseif($accountSales->getTransactionMethod()->getId() == 3 ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                if($accountSales->getAccountMobileBank()){
                    $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($accountSales->getAccountMobileBank());
                    $transaction->setSubAccountHead($subAccount);
                }
                $transaction->setProcess('Current Assets');
            }else{
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }

            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    private function insertSalesAccountReceivable(Sales $entity, AccountSales $accountSales)
    {

       $amount = $entity->getDue();
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setProcess('AccountReceivable');
            /* Assets Account - Account Receivable */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(4));
            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }

    }

    private function insertSalesVatAccountPayable(Sales $entity, AccountSales $accountSales)
    {

         $amount = $entity->getVat();
         if($amount > 0){

             $transaction = new Transaction();
             $transaction->setGlobalOption($accountSales->getGlobalOption());
             if(!empty($accountSales->getBranches())){
                 $transaction->setBranches($accountSales->getBranches());
             }
             $transaction->setAccountRefNo($accountSales->getAccountRefNo());
             $transaction->setProcessHead('Sales');
             $transaction->setProcess('AccountPayable');
             /* Current Liabilities - Sales Vat & Tax */
             $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(16));
             $transaction->setAmount('-'.$amount);
             $transaction->setCredit($amount);
             $this->_em->persist($transaction);
             $this->_em->flush();

        }

    }



    public function salesReturnTransaction(SalesReturn $entity, AccountSales $accountSales)
    {
        $this->insertSalesReturnDebit($entity,$accountSales);
        $this->insertSalesReturnCredit($entity,$accountSales);
    }

    private function insertSalesReturnDebit(SalesReturn $entity, AccountSales $accountSales)
    {

        $transaction = new Transaction();
        $transaction->setGlobalOption($accountSales->getGlobalOption());
        $transaction->setAccountRefNo($accountSales->getAccountRefNo());
        if(!empty($accountSales->getBranches())){
            $transaction->setBranches($accountSales->getBranches());
        }
        $transaction->setProcessHead('SalesReturn');
        $transaction->setProcess('Goods');
        /* Sales Revenue - Sales Return Account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(34));
        $transaction->setAmount($entity->getTotal());
        $transaction->setDebit($entity->getTotal());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    private function insertSalesReturnCredit(SalesReturn $entity, AccountSales $accountSales)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($accountSales->getGlobalOption());
        if(!empty($accountSales->getBranches())){
            $transaction->setBranches($accountSales->getBranches());
        }
        $transaction->setAccountRefNo($accountSales->getAccountRefNo());
        $transaction->setProcessHead('SalesReturn');
        $transaction->setProcess('Cash');
        /* Cash - Sales Return Payment Account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(35));
        $transaction->setAmount('-'.$entity->getTotal());
        $transaction->setCredit($entity->getTotal());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    public function salesAdjustmentTransaction(AccountSalesAdjustment $entity)
    {
        $this->insertSalesAdjustmentDebit($entity);
        $this->insertSalesAdjustmentCredit($entity);
    }

    private function insertSalesAdjustmentDebit(AccountSalesAdjustment $entity)
    {

        $amount = $entity->getSales();
        if($amount > 0) {
            $transaction = new Transaction();
            $transaction->setGlobalOption($entity->getGlobalOption());
            if(!empty($entity->getBranches())){
                $transaction->setBranches($entity->getBranches());
            }
            $transaction->setAccountRefNo($entity->getAccountRefNo());
            $transaction->setProcessHead('SalesAdjustment');
            $transaction->setUpdated($entity->getUpdated());

            /* Cash - Cash various */
            if($entity->getTransactionMethod()->getId() == 2 ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($entity->getAccountBank());
                $transaction->setSubAccountHead($subAccount);
                $transaction->setProcess('Current Assets');
            }elseif($entity->getTransactionMethod()->getId() == 3 ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($entity->getAccountMobileBank());
                $transaction->setSubAccountHead($subAccount);
                $transaction->setProcess('Current Assets');
            }elseif($entity->getTransactionMethod()->getId() == 1 ){
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }
            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }

    }

    private function insertSalesAdjustmentCredit(AccountSalesAdjustment $entity)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        if(!empty($entity->getBranches())){
            $transaction->setBranches($entity->getBranches());
        }
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('SalesAdjustment');
        $transaction->setProcess('Inventory Assets');
        /* Cash - Sales Adjustment Payment Account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(6));
        $transaction->setAmount('-'.$entity->getSales());
        $transaction->setCredit($entity->getSales());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }


	public function insertCustomerOutstandingTransaction(AccountSales $entity)
	{
		$transaction = new Transaction();
		$transaction->setGlobalOption($entity->getGlobalOption());
		$transaction->setAccountRefNo($entity->getAccountRefNo());
		$transaction->setProcessHead('Sales');
		$transaction->setUpdated($entity->getUpdated());
		$transaction->setProcess('Current Asset');
		/* Current Current Asset - Account Receivable */
		$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(4));
		/* ==== Sub Account set ====*/
        $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertCustomerAccount($entity->getCustomer());
        $transaction->setSubAccountHead($subAccount);
        $transaction->setAmount($entity->getTotalAmount());
		$transaction->setDebit($entity->getTotalAmount());
        $this->_em->persist($transaction);
		$this->_em->flush();

		$transactionCredit = new Transaction();
        $transactionCredit->setGlobalOption($entity->getGlobalOption());
        $transactionCredit->setAccountRefNo($entity->getAccountRefNo());
        $transactionCredit->setProcessHead('Sales');
        $transactionCredit->setUpdated($entity->getUpdated());
		$transactionCredit->setProcess('Long Term Liabilities');
		/* Current Current Asset - Account Receivable */
		$transactionCredit->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(49));
        /* ==== Sub Account set ====*/
        $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertCustomerAccount($entity->getCustomer());
        $transactionCredit->setSubAccountHead($subAccount);
		$transactionCredit->setAmount('-'.$entity->getTotalAmount());
		$transactionCredit->setCredit($entity->getTotalAmount());
		$this->_em->persist($transactionCredit);
		$this->_em->flush();

	}

	public function insertCustomerDiscountTransaction(AccountSales $entity)
	{
		$transaction = new Transaction();
		$transaction->setGlobalOption($entity->getGlobalOption());
		$transaction->setAccountRefNo($entity->getAccountRefNo());
		$transaction->setProcessHead('Sales');
		$transaction->setUpdated($entity->getUpdated());
		$transaction->setProcess('Miscellaneous');
		/* Current Current Asset - Account Receivable */
		$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(56));
		$transaction->setAmount($entity->getAmount());
		$transaction->setDebit($entity->getAmount());
		$this->_em->persist($transaction);
		$this->_em->flush();

		$transaction = new Transaction();
		$transaction->setGlobalOption($entity->getGlobalOption());
		$transaction->setAccountRefNo($entity->getAccountRefNo());
		$transaction->setProcessHead('Sales');
		$transaction->setUpdated($entity->getUpdated());
		$transaction->setProcess('Current Asset');
		/* Current Current Asset - Account Receivable */
		$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(4));
        /* ==== Sub Account set ====*/
        $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertCustomerAccount($entity->getCustomer());
        $transaction->setSubAccountHead($subAccount);
        $transaction->setAmount('-'.$entity->getAmount());
		$transaction->setCredit($entity->getAmount());
		$this->_em->persist($transaction);
		$this->_em->flush();

	}

	public function insertVendorDiscountTransaction(AccountPurchase $entity)
	{
		$transaction = new Transaction();
		$transaction->setGlobalOption($entity->getGlobalOption());
		$transaction->setAccountRefNo($entity->getAccountRefNo());
		$transaction->setProcessHead('Discount form Vendor');
		$transaction->setUpdated($entity->getUpdated());
		$transaction->setProcess('Current Liabilities');
		/* Current Current Asset - Account Receivable */
		$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(13));
        /* ==== Sub Account set ====*/
        if($entity->getGlobalOption()->getMainApp()->getSlug() == 'miss'){
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMedicineVendorAccount($entity->getMedicineVendor());
        }elseif ($entity->getGlobalOption()->getMainApp()->getSlug() == 'inventory'){
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertInventoryVendorAccount($entity->getVendor());
        }else{
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertVendorAccount($entity->getAccountVendor());
        }
        $transaction->setSubAccountHead($subAccount);
		$transaction->setAmount($entity->getPayment());
		$transaction->setDebit($entity->getPayment());
		$this->_em->persist($transaction);
		$this->_em->flush();

		$transaction = new Transaction();
		$transaction->setGlobalOption($entity->getGlobalOption());
		$transaction->setAccountRefNo($entity->getAccountRefNo());
		$transaction->setProcessHead('Discount form Vendor');
		$transaction->setUpdated($entity->getUpdated());
		$transaction->setProcess('Current Liabilities');
		/* Current Current Asset - Account Receivable */
		$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(59));
		$transaction->setAmount('-'.$entity->getPayment());
		$transaction->setCredit($entity->getPayment());
		$this->_em->persist($transaction);
		$this->_em->flush();

	}


	public function onlineOrderTransaction($entity,$onlineOrder)
    {
        $this->insertOnlineOrderItem($entity,$onlineOrder);
        $this->insertOnlineOrderCash($entity,$onlineOrder);
        $this->insertOnlineOrderAccountReceivable($entity,$onlineOrder);
        $this->insertOnlineOrderAccountPayable($entity,$onlineOrder);
        $this->insertOnlineOrderVatAccountPayable($entity,$onlineOrder);

    }

    private function insertOnlineOrderItem($entity , AccountOnlineOrder $onlineOrder)
    {

        $amount =  $entity->getGrandTotalAmount();
        $transaction = new Transaction();
        $transaction->setGlobalOption($onlineOrder->getGlobalOption());
        $transaction->setAccountRefNo($onlineOrder->getAccountRefNo());
        $transaction->setProcessHead('Online');
        $transaction->setProcess('Goods');
        /* Sales Revenue - Sales goods account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(6));
        $transaction->setAmount('-'.$amount);
        $transaction->setCredit($amount);
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    private function insertOnlineOrderCash($entity,$onlineOrder)
    {
        $amount = $entity->getPaidAmount();
        if($amount > 0) {
            $transaction = new Transaction();
            $transaction->setGlobalOption($onlineOrder->getGlobalOption());
            $transaction->setAccountRefNo($onlineOrder->getAccountRefNo());
            $transaction->setProcessHead('Online');

            $transaction->setUpdated($entity->getUpdated());
            /* Cash - Cash various */
            if($entity->getTransactionMethod()->getId() == 1 ){
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }elseif($entity->getTransactionMethod()->getId() == 2 ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                $transaction->setProcess('Current Assets');
            }if($entity->getTransactionMethod()->getId() == 3 ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                $transaction->setProcess('Current Assets');
            }

            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    private function insertOnlineOrderAccountReceivable($entity,$accountSales)
    {

        $amount = $entity->getDueAmount();
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setProcess('AccountReceivable');
            /* Assets Account - Account Receivable */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(4));
            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }

    }

    private function insertOnlineOrderAccountPayable($entity,$onlineOrder)
    {

        $amount = $entity->getReturnAmount();
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($onlineOrder->getGlobalOption());
            $transaction->setAccountRefNo($onlineOrder->getAccountRefNo());
            $transaction->setProcessHead('Online');
            $transaction->setProcess('AccountPayable');
            /* Assets Account - Account Payable */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(22));
            $transaction->setAmount('-'.$amount);
            $transaction->setCredit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }

    }

    private function insertOnlineOrderVatAccountPayable($entity,$onlineOrder)
    {

        $amount = $entity->getVat();
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($onlineOrder->getGlobalOption());
            $transaction->setAccountRefNo($onlineOrder->getAccountRefNo());
            $transaction->setProcessHead('Online');
            $transaction->setProcess('AccountPayable');
            /* Current Liabilities - Sales Vat & Tax */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(16));
            $transaction->setAmount('-'.$amount);
            $transaction->setCredit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }

    }

    public function insertAccountSalesTransaction(AccountSales $entity){

        $this->insertAccountSalesDebitTransaction($entity);
        $this->insertAccountSalesCreditTransaction($entity);

    }

    public function  insertAccountSalesDebitTransaction(AccountSales $entity)
    {

        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        if(!empty($entity->getBranches())){
            $transaction->setBranches($entity->getBranches());
        }
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('Sales');
        $transaction->setUpdated($entity->getUpdated());

        /* Cash - Cash various */
        if($entity->getTransactionMethod()->getId() == 2 ){
            /* Current Asset Bank Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($entity->getAccountBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getTransactionMethod()->getId() == 3 ){
            /* Current Asset Mobile Account Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($entity->getAccountMobileBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getTransactionMethod()->getId() == 1 ){
            /* Cash - Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
            $transaction->setProcess('Cash');

        }
        $transaction->setAmount($entity->getAmount());
        $transaction->setDebit($entity->getAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();
    }

    public function  insertAccountSalesCreditTransaction(AccountSales $entity)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        if(!empty($entity->getBranches())){
            $transaction->setBranches($entity->getBranches());
        }
        $transaction->setProcess('Current Asset');
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setUpdated($entity->getUpdated());
        $transaction->setProcessHead('Sales');
        /* Sales Revenue - Sales Due Payment credit */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(4));
        /* ==== Sub Account set ====*/
        $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertCustomerAccount($entity->getCustomer());
        $transaction->setSubAccountHead($subAccount);
        $transaction->setAmount('-'.$entity->getAmount());
        $transaction->setCredit($entity->getAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();
    }

    public function insertPettyCashTransaction($entity){

        $this->insertPettyCashDebitTransaction($entity);
        $this->insertPettyCashCreditTransaction($entity);

    }

    public function  insertPettyCashDebitTransaction($entity)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('Petty Cash');
        $transaction->setProcess('Account Receivable');
        /* Cash - Petty Cash */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(4));
        $transaction->setAmount($entity->getAmount());
        $transaction->setDebit($entity->getAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();
    }

    public function  insertPettyCashCreditTransaction($entity)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('Petty Cash');
        $transaction->setProcess('Cash Credit');
        /* Cash - Cash credit */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
        $transaction->setAmount('-'.$entity->getAmount());
        $transaction->setCredit($entity->getAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();
    }

    public function returnPettyCashTransaction($entity)
    {
        $this->returnPettyCashDebitTransaction($entity);
        $this->returnPettyCashCreditTransaction($entity);
        $this->_em->getRepository('AccountingBundle:AccountCash')->insertPettyCashReturn($entity);

    }

    public function returnPettyCashDebitTransaction($entity)
    {

        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('Petty Cash Return');
        $transaction->setProcess('Cash');
        /* Cash - Cash various */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
        $transaction->setAmount($entity->getAmount());
        $transaction->setDebit($entity->getAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();
    }

    public function returnPettyCashCreditTransaction($entity)
    {

        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('Petty Cash Return');
        $transaction->setProcess('Account Receivable');
        /* Cash - Petty Cash */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(41));
        $transaction->setAmount('-'.$entity->getAmount());
        $transaction->setCredit($entity->getAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();
    }

    public function insertExpenditureTransaction($entity)
    {
        $this->insertExpenditureDebitTransaction($entity);
        $this->insertExpenditureCreditTransaction($entity);
    }

    public function insertExpenditureDebitTransaction(Expenditure $entity)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        if(!empty($entity->getBranches())){
            $transaction->setBranches($entity->getBranches());
        }
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('Expenditure');
        $transaction->setProcess('Operating Expense');
        /* Cash - Cash credit */
        $transaction->setAccountHead($entity->getAccountHead());
        $transaction->setAmount($entity->getAmount());
        $transaction->setDebit($entity->getAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    public function insertExpenditureCreditTransaction(Expenditure $entity)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        if(!empty($entity->getBranches())){
            $transaction->setBranches($entity->getBranches());
        }
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('Expenditure');

        /* Cash - Cash various */
        if($entity->getTransactionMethod()->getId() == 2 ){
            /* Current Asset Bank Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($entity->getAccountBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getTransactionMethod()->getId() == 3 ){
            /* Current Asset Mobile Account Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($entity->getAccountMobileBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getTransactionMethod()->getId() == 1 ){
            /* Cash - Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
            $transaction->setProcess('Cash');
        }

        $transaction->setAmount('-'.$entity->getAmount());
        $transaction->setCredit($entity->getAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    public function insertPurchaseExpenditureTransaction($entity)
    {
        $this->insertPurchaseExpenditureDebitTransaction($entity);
        $this->insertPurchaseExpenditureCreditTransaction($entity);
    }

    public function insertPurchaseExpenditureDebitTransaction(AccountPurchase $entity)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('PurchaseExpenditure');
        $transaction->setProcess('Operating Expense');
        /* Cash - Cash credit */
        $transaction->setAccountHead($entity->getAccountHead());
        $transaction->setAmount($entity->getPayment());
        $transaction->setDebit($entity->getPayment());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    public function insertPurchaseExpenditureCreditTransaction(AccountPurchase $entity)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($entity->getGlobalOption());
        $transaction->setAccountRefNo($entity->getAccountRefNo());
        $transaction->setProcessHead('PurchaseExpenditure');

        /* Cash - Cash various */
        if($entity->getTransactionMethod()->getId() == 2 ){
            /* Current Asset Bank Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($entity->getAccountBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getTransactionMethod()->getId() == 3 ){
            /* Current Asset Mobile Account Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($entity->getAccountMobileBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($entity->getTransactionMethod()->getId() == 1 ){
            /* Cash - Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
            $transaction->setProcess('Cash');
        }

        $transaction->setAmount('-'.$entity->getPayment());
        $transaction->setCredit($entity->getPayment());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    public function insertSalaryTransaction(PaymentSalary $paymentSalary)
    {
            $this->insertSalaryDebitCashTransaction($paymentSalary);
            $this->insertSalaryCreditCashTransaction($paymentSalary);
    }

    public function insertSalaryDebitCashTransaction($paymentSalary)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($paymentSalary->getGlobalOption());
        $transaction->setAccountRefNo($paymentSalary->getAccountRefNo());
        $transaction->setProcessHead('PaymentSalary');
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(25));
        $transaction->setProcess('General & Administrative expenses');
        /* Cash - Cash credit */
        $transaction->setAmount($paymentSalary->getTotalAmount());
        $transaction->setDebit($paymentSalary->getTotalAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    public function insertSalaryCreditCashTransaction($paymentSalary)
    {
        $transaction = new Transaction();
        $transaction->setGlobalOption($paymentSalary->getGlobalOption());
        $transaction->setAccountRefNo($paymentSalary->getAccountRefNo());
        $transaction->setProcessHead('PaymentSalary');

        /* Cash - Cash various */
        if($paymentSalary->getTransactionMethod()->getId() == 2 ){
            /* Current Asset Bank Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($paymentSalary->getAccountBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($paymentSalary->getTransactionMethod()->getId() == 3 ){
            /* Current Asset Mobile Account Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($paymentSalary->getAccountMobileBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }else{
            /* Cash - Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
            $transaction->setProcess('Cash');
        }

        /* Cash - Cash various */
        $transaction->setAmount('-'.$paymentSalary->getTotalAmount());
        $transaction->setCredit($paymentSalary->getTotalAmount());
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    public function insertDamageTransaction(Damage $damage)
    {
        $this->insertDamageDebitTransaction($damage);
        $this->insertDamageCreditTransaction($damage);

    }

    public function insertDamageDebitTransaction($damage)
    {
        $transaction = new Transaction();
        $globalOption = $damage->getInventoryConfig()->getGlobalOption();
        $accountHead = $this->_em->getRepository('AccountingBundle:AccountHead')->find(48);
        $transaction->setGlobalOption($globalOption);
        $transaction->setAccountHead($accountHead);
        $transaction->setProcess('Long Term Liabilities');
        /* Cash - Cash various */
        $transaction->setAmount($damage->getTotal());
        $transaction->setDebit($damage->getTotal());
        $this->_em->persist($transaction);
        $this->_em->flush();
    }

    public function insertDamageCreditTransaction($damage)
    {
        $transaction = new Transaction();
        $globalOption = $damage->getInventoryConfig()->getGlobalOption();
        $accountHead = $this->_em->getRepository('AccountingBundle:AccountHead')->find(47);
        $transaction->setGlobalOption($globalOption);
        $transaction->setAccountHead($accountHead);
        $transaction->setProcess('Inventory Assets');
        /* Cash - Long Term Liabilities	 */
        $transaction->setAmount('-'.$damage->getTotal());
        $transaction->setCredit($damage->getTotal());
        $this->_em->persist($transaction);
        $this->_em->flush();
    }

    private  function getNetBalance($inventory)
    {

        $qb = $this->_em->createQueryBuilder();
        $qb->select('e');
        $qb->addSelect('e.balance AS balance');
        $qb->from('AccountingBundle:Transaction','e');
        $qb->where("e.inventoryConfig = :inventory");
        $qb->setParameter('inventory', $inventory->getId());
        $qb->orderBy('e.id','desc');
        $qb->setMaxResults(1);
        $netTotal = $qb->getQuery()->getSingleResult();
        if(empty($netTotal) > 0 ){
            return 0;
        }else{
            return $netTotal;
        }

    }

    /** =========================== HOSPITAL MANAGEMENT SYSTEM    =========================== */


    public function hmsSalesTransaction(InvoiceTransaction $entity,$accountSales)
    {
        $this->insertHmsCashDebit($entity,$accountSales);
        $this->insertHmsCashCredit($entity,$accountSales);
        if($entity->getVat() > 0){
            $this->insertHmsSalesVatAccountPayable($entity,$accountSales);
        }
    }

    private function insertHmsCashDebit(InvoiceTransaction $entity , AccountSales $accountSales)
    {
        $amount = $entity->getPayment();
        if($amount > 0) {
            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales Advance');
            $transaction->setUpdated($entity->getUpdated());

            /* Cash - Cash various */
            if($accountSales->getTransactionMethod()->getId() == 2 ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($accountSales->getAccountBank());
                $transaction->setSubAccountHead($subAccount);
                $transaction->setProcess('Current Assets');
            }elseif($accountSales->getTransactionMethod()->getId() == 3 ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($accountSales->getAccountMobileBank());
                $transaction->setSubAccountHead($subAccount);
                $transaction->setProcess('Current Assets');
            }else{
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }

            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    public function insertHmsCashCredit(InvoiceTransaction $entity , AccountSales $accountSales)
    {

        $transaction = new Transaction();
	    $transaction->setGlobalOption($accountSales->getGlobalOption());
	    if(!empty($accountSales->getBranches())){
		    $transaction->setBranches($accountSales->getBranches());
	    }
	    $transaction->setAccountRefNo($accountSales->getAccountRefNo());
        $transaction->setProcessHead('Sales Advance');
        $transaction->setProcess('AccountPayable');
        $transaction->setUpdated($entity->getUpdated());
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(13));
        $transaction->setAmount('-'.$entity->getPayment());
        $transaction->setCredit($entity->getPayment());
        $this->_em->persist($transaction);
        $this->_em->flush();
        return $transaction;

    }

    private function insertHmsSalesVatAccountPayable(InvoiceTransaction $entity, AccountSales $accountSales)
    {

        $amount = $entity->getVat();
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setProcess('AccountPayable');
            /* Current Liabilities - Sales Vat & Tax */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(16));
            $transaction->setAmount('-'.$amount);
            $transaction->setCredit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }

    }

    public function hmsSalesFinal(Invoice $entity,$accountSales)
    {
        $this->insertHmsFinalCashDebit($accountSales);
        $this->insertHmsFinalCashCredit($accountSales);
    }

    private function insertHmsFinalCashDebit(AccountSales $accountSales)
    {
        $amount = $accountSales->getTotalAmount();
        if($amount > 0) {
            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setUpdated($accountSales->getUpdated());
            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    public function insertHmsFinalCashCredit( AccountSales $accountSales)
    {
        $amount = $accountSales->getTotalAmount();
        $transaction = new Transaction();
        $transaction->setGlobalOption($accountSales->getGlobalOption());
        if(!empty($accountSales->getBranches())){
            $transaction->setBranches($accountSales->getBranches());
        }
        $transaction->setAccountRefNo($accountSales->getAccountRefNo());
        $transaction->setProcessHead('Sales');
        $transaction->setProcess('Operating Revenue');
        $transaction->setUpdated($accountSales->getUpdated());
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(8));
        $transaction->setAmount('-'.$amount);
        $transaction->setCredit($amount);
        $this->_em->persist($transaction);
        $this->_em->flush();
        return $transaction;

    }


    /** =========================== HOSPITAL MANAGEMENT SYSTEM    =========================== */

    public function restaurantSalesTransaction(\Appstore\Bundle\RestaurantBundle\Entity\Invoice $entity , $accountSales)
    {
        $this->insertRestaurantCashDebit($entity,$accountSales);
        $this->insertRestaurantCashCredit($entity,$accountSales);
        if($entity->getVat() > 0){
            $this->insertRestaurantSalesVatAccountPayable($entity,$accountSales);
        }
    }

    private function insertRestaurantCashDebit(\Appstore\Bundle\RestaurantBundle\Entity\Invoice $entity , AccountSales $accountSales)
    {
        $amount = $entity->getPayment();
        if($amount > 0) {
            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setUpdated($entity->getUpdated());

            /* Cash - Cash various */
            /* Cash - Cash various */
            if($accountSales->getTransactionMethod()->getId() == 2 ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($accountSales->getAccountBank());
                $transaction->setSubAccountHead($subAccount);
                $transaction->setProcess('Current Assets');
            }elseif($accountSales->getTransactionMethod()->getId() == 3 ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($accountSales->getAccountMobileBank());
                $transaction->setSubAccountHead($subAccount);
                $transaction->setProcess('Current Assets');
            }else{
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }

            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    public function insertRestaurantCashCredit(\Appstore\Bundle\RestaurantBundle\Entity\Invoice $entity , AccountSales $accountSales)
    {

        $transaction = new Transaction();
        $transaction->setGlobalOption($accountSales->getGlobalOption());
        if(!empty($accountSales->getBranches())){
            $transaction->setBranches($accountSales->getBranches());
        }
        $transaction->setProcessHead('Sales');
        $transaction->setProcess('Operating Revenue');
        $transaction->setAccountRefNo($accountSales->getAccountRefNo());
        $transaction->setUpdated($entity->getUpdated());
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(8));
        $transaction->setAmount('-'.$entity->getPayment());
        $transaction->setCredit($entity->getPayment());
        $this->_em->persist($transaction);
        $this->_em->flush();
        return $transaction;

    }

    private function insertRestaurantSalesVatAccountPayable(\Appstore\Bundle\RestaurantBundle\Entity\Invoice $entity, AccountSales $accountSales)
    {

        $amount = $entity->getVat();
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setProcess('AccountPayable');
            /* Current Liabilities - Sales Vat & Tax */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(16));
            $transaction->setAmount('-'.$amount);
            $transaction->setCredit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }

    }


    /* ==================== GLOBAL SALES & PURCHASE =======================================*/


    public function salesGlobalTransaction(AccountSales $accountSales)
    {
        $this->insertGlobalCashDebit($accountSales);
        $this->insertGlobalGoodsCredit($accountSales);
        $this->insertGlobalSalesAccountReceivable($accountSales);
        if($accountSales->getVat() > 0){
            $this->insertGlobalSalesVatAccountPayable($accountSales);
        }
    }

    private function insertGlobalCashDebit(AccountSales $accountSales)
    {
        $amount = $accountSales->getAmount();
        if($amount > 0) {
            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setUpdated($accountSales->getUpdated());

            /* Cash - Cash various */
            if($accountSales->getTransactionMethod() and $accountSales->getTransactionMethod()->getSlug() == "bank" ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                if($accountSales->getAccountBank()){
                    $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($accountSales->getAccountBank());
                    $transaction->setSubAccountHead($subAccount);
                }
                $transaction->setProcess('Current Assets');
            }elseif($accountSales->getTransactionMethod() and $accountSales->getTransactionMethod()->getSlug() == "mobile" ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                if($accountSales->getAccountMobileBank()){
                    $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($accountSales->getAccountMobileBank());
                    $transaction->setSubAccountHead($subAccount);
                }
                $transaction->setProcess('Current Assets');
            }else{
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }

            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    public function insertGlobalGoodsCredit(AccountSales $accountSales)
    {

        $amount = $accountSales->getTotalAmount();
        $transaction = new Transaction();
        $transaction->setGlobalOption($accountSales->getGlobalOption());
        if(!empty($accountSales->getBranches())){
            $transaction->setBranches($accountSales->getBranches());
        }
        $transaction->setAccountRefNo($accountSales->getAccountRefNo());
        $transaction->setProcessHead('Sales');
        $transaction->setProcess('Goods');
        /* Sales Revenue - Sales goods account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(6));
        $transaction->setAmount('-'.$amount);
        $transaction->setCredit($amount);
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    private function insertGlobalSalesAccountReceivable(AccountSales $accountSales)
    {

        $amount = ($accountSales->getTotalAmount() - $accountSales->getAmount());
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setProcess('AccountReceivable');
            /* Assets Account - Account Receivable */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(4));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertCustomerAccount($accountSales->getCustomer());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }

    }

    private function insertGlobalSalesVatAccountPayable(AccountSales $accountSales)
    {

        $amount = $accountSales->getVat();
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setProcess('AccountPayable');
            /* Current Liabilities - Sales Vat & Tax */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(16));
            $transaction->setAmount('-'.$amount);
            $transaction->setCredit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }

    }

	public function salesReturnGlobalCashTransaction(AccountJournal $accountJournal,$source='')
	{
		$this->insertGlobalSalesReturnCashAsset($accountJournal);
		$this->insertGlobalSalesReturnCash($accountJournal);
	}

	private function insertGlobalSalesReturnCashAsset(AccountJournal $account)
	{

		$amount =  $account->getAmount();
		$transaction = new Transaction();
		$transaction->setGlobalOption($account->getGlobalOption());
		$transaction->setAccountRefNo($account->getAccountRefNo());
		$transaction->setProcessHead('Sales Return');
		$transaction->setProcess('Goods');
		/* Sales Revenue - Sales Return Account */
		$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(34));
		$transaction->setAmount($amount);
		$transaction->setDebit($amount);
		$this->_em->persist($transaction);
		$this->_em->flush();


	}

	private function insertGlobalSalesReturnCash(AccountJournal $account)
	{

		$amount = $account->getAmount();
		if($amount > 0){

			$transaction = new Transaction();
			$transaction->setGlobalOption($account->getGlobalOption());
			$transaction->setAccountRefNo($account->getAccountRefNo());
			$transaction->setProcessHead('SalesReturn');
			$transaction->setProcess('Cash');
			/* Cash - Sales Return Payment Account */
			$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
			$transaction->setAmount('-'.$amount);
			$transaction->setCredit($amount);
			$this->_em->persist($transaction);
			$this->_em->flush();

		}
	}


	public function salesReturnGlobalPayableTransaction(AccountSales $accountSales,$source='')
	{
		$this->insertGlobalSalesReturnAsset($accountSales);
		$this->insertGlobalSalesReturnPayable($accountSales);
	}

	private function insertGlobalSalesReturnAsset(AccountSales $accountSales)
	{

		$amount =  $accountSales->getAmount();
		$transaction = new Transaction();
		$transaction->setGlobalOption($accountSales->getGlobalOption());
		$transaction->setAccountRefNo($accountSales->getAccountRefNo());
		$transaction->setProcessHead('Sales Return');
		$transaction->setProcess('Goods');
		/* Sales Revenue - Sales Return Account */
		$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(34));
		$transaction->setAmount($amount);
		$transaction->setDebit($amount);
		$this->_em->persist($transaction);
		$this->_em->flush();


	}

	private function insertGlobalSalesReturnPayable(AccountSales $accountSales)
	{

		$amount = $accountSales->getAmount();
		if($amount > 0){

			$transaction = new Transaction();
			$transaction->setGlobalOption($accountSales->getGlobalOption());
			$transaction->setAccountRefNo($accountSales->getAccountRefNo());
			$transaction->setProcessHead('SalesReturn');
			$transaction->setProcess('Current Liabilities');
			/* Cash - Sales Return Payment Account */
			$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(35));
			$transaction->setAmount('-'.$amount);
			$transaction->setCredit($amount);
			$this->_em->persist($transaction);
			$this->_em->flush();

		}
	}


	public function purchaseGlobalTransaction(AccountPurchase $accountPurchase,$source='')
    {
        $this->insertGlobalInventoryAsset($accountPurchase);
	    if(!empty($accountPurchase->getTransactionMethod()) and $accountPurchase->getPayment() > 0){
	        $this->insertGlobalPurchaseCash($accountPurchase);
        }
        $this->insertGlobalPurchaseAccountPayable($accountPurchase);
    }

    private function insertGlobalInventoryAsset(AccountPurchase $accountPurchase)
    {

        $amount = $accountPurchase->getPurchaseAmount();
        $transaction = new Transaction();
        $transaction->setGlobalOption($accountPurchase->getGlobalOption());
        $transaction->setProcessHead('Purchase');
        $transaction->setProcess('Inventory Assets');
        $transaction->setAccountRefNo($accountPurchase->getAccountRefNo());
        $transaction->setUpdated($accountPurchase->getUpdated());
        /* Inventory Assets - Purchase Goods Received account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(6));
        $transaction->setAmount($amount);
        $transaction->setDebit($amount);
        $this->_em->persist($transaction);
        $this->_em->flush();


    }

    private function insertGlobalPurchaseCash(AccountPurchase $accountPurchase)
    {

        $amount = $accountPurchase->getPayment();
        if($amount > 0) {

            $transaction = new Transaction();
            $transaction->setGlobalOption($accountPurchase->getGlobalOption());
            $transaction->setProcessHead('Purchase');
            $transaction->setProcess('Cash');
            $transaction->setAccountRefNo($accountPurchase->getAccountRefNo());
            $transaction->setUpdated($accountPurchase->getUpdated());

            /* Cash - Cash various */

            /* Cash - Cash various */
            if($accountPurchase->getTransactionMethod()->getId() == 2 ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                if($accountPurchase->getAccountBank()){
                    $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($accountPurchase->getAccountBank());
                    $transaction->setSubAccountHead($subAccount);
                }
                $transaction->setProcess('Current Assets');
            }elseif($accountPurchase->getTransactionMethod()->getId() == 3 ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                if($accountPurchase->getAccountMobileBank()){
                    $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($accountPurchase->getAccountMobileBank());
                    $transaction->setSubAccountHead($subAccount);
                }
                $transaction->setProcess('Current Assets');
            }else{
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }

            $transaction->setAmount('-' . $amount);
            $transaction->setCredit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    private function insertGlobalPurchaseAccountPayable(AccountPurchase $accountPurchase)
    {
        $amount = ($accountPurchase->getPurchaseAmount() - $accountPurchase->getPayment());
        if($amount > 0){
            $subAccount = NULL;
            $transaction = new Transaction();
            $transaction->setGlobalOption($accountPurchase->getGlobalOption());
            $transaction->setProcessHead('Purchase');
            $transaction->setProcess('Current Liabilities');
            $transaction->setAccountRefNo($accountPurchase->getAccountRefNo());
            $transaction->setUpdated($accountPurchase->getUpdated());
            /* Current Liabilities-Purchase Account payable */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(13));
            if($accountPurchase->getGlobalOption()->getMainApp()->getSlug() == 'miss' and $accountPurchase->getMedicineVendor()){
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMedicineVendorAccount($accountPurchase->getMedicineVendor());
            }elseif ($accountPurchase->getGlobalOption()->getMainApp()->getSlug() == 'inventory' and $accountPurchase->getVendor()){
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertInventoryVendorAccount($accountPurchase->getVendor());
            }elseif($accountPurchase->getAccountVendor()){
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertVendorAccount($accountPurchase->getAccountVendor());
            }
            $transaction->setSubAccountHead($subAccount);
            $transaction->setAmount('-'.$amount);
            $transaction->setCredit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    public function purchaseReturnGlobalTransaction($accountPurchase,$source='')
    {
        $this->insertGlobalInventoryReturnAsset($accountPurchase);
        $this->insertGlobalPurchaseAccountReceivable($accountPurchase);
    }

    private function insertGlobalInventoryReturnAsset(AccountPurchase $accountPurchase)
    {

        $amount =  $accountPurchase->getPayment();
        $transaction = new Transaction();
        $transaction->setGlobalOption($accountPurchase->getGlobalOption());
        $transaction->setAccountRefNo($accountPurchase->getAccountRefNo());
        $transaction->setProcessHead('Purchase Return');
        $transaction->setProcess('InventoryAssets');
        /* Sales Revenue - Purchase Return account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(6));
        $transaction->setAmount('-'.$amount);
        $transaction->setCredit($amount);
        $this->_em->persist($transaction);
        $this->_em->flush();


    }

    private function insertGlobalPurchaseAccountReceivable(AccountPurchase $accountPurchase)
    {

        $amount = $accountPurchase->getPayment();
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($accountPurchase->getGlobalOption());
            $transaction->setAccountRefNo($accountPurchase->getAccountRefNo());
            $transaction->setProcessHead('Purchase Return');
            $transaction->setProcess('AccountReceivable');
            /* Assets Account - Account Receivable */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(13));

            if($accountPurchase->getGlobalOption()->getMainApp()->getSlug() == 'miss'){
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMedicineVendorAccount($accountPurchase->getMedicineVendor());
            }elseif ($accountPurchase->getGlobalOption()->getMainApp()->getSlug() == 'inventory'){
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertInventoryVendorAccount($accountPurchase->getVendor());
            }else{
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertVendorAccount($accountPurchase->getAccountVendor());
            }
            $transaction->setSubAccountHead($subAccount);
            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }
    }


	public function insertGlobalDamageTransaction($global,$damage)
	{
		$this->insertGlobalDamageDebitTransaction($global,$damage);
		$this->insertGlobalDamageCreditTransaction($global,$damage);

	}

	public function insertGlobalDamageDebitTransaction($globalOption,$damage)
	{
		$transaction = new Transaction();
		$accountHead = $this->_em->getRepository('AccountingBundle:AccountHead')->find(48);
		$transaction->setGlobalOption($globalOption);
		$transaction->setAccountHead($accountHead);
		$transaction->setProcessHead('Damage');
		$transaction->setProcess('Long Term Liabilities');
		/* Cash - Cash various */
		$transaction->setAmount($damage->getSubTotal());
		$transaction->setDebit($damage->getSubTotal());
		$this->_em->persist($transaction);
		$this->_em->flush();
	}

	public function insertGlobalDamageCreditTransaction($globalOption,$damage)
	{
		$transaction = new Transaction();
		$accountHead = $this->_em->getRepository('AccountingBundle:AccountHead')->find(6);
		$transaction->setGlobalOption($globalOption);
		$transaction->setAccountHead($accountHead);
		$transaction->setProcessHead('Damage');
		$transaction->setProcess('Inventory Assets');
		/* Cash - Long Term Liabilities	 */
		$transaction->setAmount('-'.$damage->getSubTotal());
		$transaction->setCredit($damage->getSubTotal());
		$this->_em->persist($transaction);
		$this->_em->flush();

	}


    public function purchaseCommissionTransaction($global,AccountPurchaseCommission $commission)
	{
		$this->purchaseCommissionTransactionDebit($global,$commission);
		$this->purchaseCommissionTransactionCredit($global,$commission);

	}

	public function purchaseCommissionTransactionDebit($globalOption, AccountPurchaseCommission $commission)
	{
		$transaction = new Transaction();
		$transaction->setGlobalOption($globalOption);
		$transaction->setProcessHead('Purchase Commission');

        if($commission->getTransactionMethod()->getId() == 2 ){
            /* Current Asset Bank Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($commission->getAccountBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }elseif($commission->getTransactionMethod()->getId() == 3 ){
            /* Current Asset Mobile Account Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($commission->getAccountMobileBank());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setProcess('Current Assets');
        }else{
            /* Cash - Cash Debit */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
            $transaction->setProcess('Cash');
        }
		$transaction->setAmount($commission->getAmount());
		$transaction->setDebit($commission->getAmount());
		$this->_em->persist($transaction);
		$this->_em->flush();
	}

	public function purchaseCommissionTransactionCredit($globalOption,AccountPurchaseCommission $commission)
	{
		$transaction = new Transaction();
		$accountHead = $this->_em->getRepository('AccountingBundle:AccountHead')->find(6);
		$transaction->setGlobalOption($globalOption);
		$transaction->setAccountHead($accountHead);
		$transaction->setProcessHead('Purchase Commission');
		$transaction->setProcess('Operating Revenue');
		/* Cash - Long Term Liabilities	 */
		$transaction->setAmount('-'.$commission->getAmount());
		$transaction->setCredit($commission->getAmount());
		$this->_em->persist($transaction);
		$this->_em->flush();

	}


    /** =========================== HOSPITAL MANAGEMENT SYSTEM  =========================== */

    public function approvedDeleteRecord($entity,$process){

        $qb = $this->_em->createQueryBuilder();
        $qb->from('AccountingBundle:Transaction','e');
        $qb->where("e.globalOption = :globalOption");
        $qb->setParameter('globalOption', $entity->getGlobalOption()->getId());
        $qb->andWhere("e.process = :process");
        $qb->setParameter('process', $process);
        $qb->andWhere("e.accountRefNo = :accountRefNo");
        $qb->setParameter('accountRefNo', $entity->getAccountRefNo());
        $result = $qb->getQuery()->getResult();
        foreach ($result as $row){
            $this->_em->remove($row);
            $this->_em->flush();
        }

    }

    /** ======================== DMS ===============================*/

    public function dmsTransaction(DmsTreatmentPlan $treatmentPlan)
    {
        $this->insertDmsSalesCashDebit($treatmentPlan);
        $this->insertDmsCashCredit($treatmentPlan);
    }

    private function insertDmsSalesCashDebit(DmsTreatmentPlan $entity)
    {
        $amount = $entity->getPayment();
        $invoice = $entity->getDmsInvoice();
        if($amount > 0) {
            $transaction = new Transaction();
            $transaction->setGlobalOption($invoice->getDmsConfig()->getGlobalOption());
            $transaction->setAccountRefNo($invoice->getInvoice());
            $transaction->setProcessHead('Sales');
            $transaction->setUpdated($entity->getUpdated());

            if($entity->getTransactionMethod()->getId() == 2 ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($entity->getAccountBank());
                $transaction->setSubAccountHead($subAccount);
                $transaction->setProcess('Current Assets');
            }elseif($entity->getTransactionMethod()->getId() == 3 ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($entity->getAccountMobileBank());
                $transaction->setSubAccountHead($subAccount);
                $transaction->setProcess('Current Assets');
            }else{
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }

            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    public function insertDmsCashCredit(DmsTreatmentPlan $entity)
    {

        $invoice = $entity->getDmsInvoice();
        $transaction = new Transaction();
        $transaction->setGlobalOption($invoice->getDmsConfig()->getGlobalOption());
        $transaction->setAccountRefNo($invoice->getInvoice());

        $transaction->setProcessHead('Sales');
        $transaction->setProcess('Operating Revenue');
        $transaction->setAccountRefNo($invoice->getInvoice());
        $transaction->setUpdated($entity->getUpdated());
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(8));
        $transaction->setAmount('-'.$entity->getPayment());
        $transaction->setCredit($entity->getPayment());
        $this->_em->persist($transaction);
        $this->_em->flush();
        return $transaction;

    }


	/** =========================== HOSPITAL MANAGEMENT SYSTEM    =========================== */


	public function hotelSalesTransaction(HotelInvoiceTransaction $entity,$accountSales)
	{
		$this->insertHotelCashDebit($entity,$accountSales);
		$this->insertHotelCashCredit($entity,$accountSales);
		if($entity->getVat() > 0){
			$this->insertHotelSalesVatAccountPayable($entity,$accountSales);
		}
	}

	private function insertHotelCashDebit(HotelInvoiceTransaction $entity , AccountSales $accountSales)
	{
		$amount = $entity->getPayment();
		if($amount > 0) {
			$transaction = new Transaction();
			$transaction->setGlobalOption($accountSales->getGlobalOption());
			if(!empty($accountSales->getBranches())){
				$transaction->setBranches($accountSales->getBranches());
			}
			$transaction->setAccountRefNo($accountSales->getAccountRefNo());
			$transaction->setProcessHead('Sales');
			$transaction->setUpdated($entity->getUpdated());

            /* Cash - Cash various */
            if($accountSales->getTransactionMethod()->getId() == 2 ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                if($accountSales->getAccountBank()){
                    $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($accountSales->getAccountBank());
                    $transaction->setSubAccountHead($subAccount);
                }
                $transaction->setProcess('Current Assets');
            }elseif($accountSales->getTransactionMethod()->getId() == 3 ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                if($accountSales->getAccountMobileBank()){
                    $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($accountSales->getAccountMobileBank());
                    $transaction->setSubAccountHead($subAccount);
                }
                $transaction->setProcess('Current Assets');
            }else{
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }

			$transaction->setAmount($amount);
			$transaction->setDebit($amount);
			$this->_em->persist($transaction);
			$this->_em->flush();
		}
	}

	public function insertHotelCashCredit(HotelInvoiceTransaction $entity , AccountSales $accountSales)
	{

		$transaction = new Transaction();
		$transaction->setGlobalOption($accountSales->getGlobalOption());
		if(!empty($accountSales->getBranches())){
			$transaction->setBranches($accountSales->getBranches());
		}
		$transaction->setAccountRefNo($accountSales->getAccountRefNo());
		$transaction->setProcessHead('Sales');
		$transaction->setProcess('Operating Revenue');
		$transaction->setUpdated($entity->getUpdated());
		$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(8));
		$transaction->setAmount('-'.$entity->getPayment());
		$transaction->setCredit($entity->getPayment());
		$this->_em->persist($transaction);
		$this->_em->flush();
		return $transaction;

	}

	private function insertHotelSalesVatAccountPayable(HotelInvoiceTransaction $entity, AccountSales $accountSales)
	{

		$amount = $entity->getVat();
		if($amount > 0){

			$transaction = new Transaction();
			$transaction->setGlobalOption($accountSales->getGlobalOption());
			if(!empty($accountSales->getBranches())){
				$transaction->setBranches($accountSales->getBranches());
			}
			$transaction->setAccountRefNo($accountSales->getAccountRefNo());
			$transaction->setProcessHead('Sales');
			$transaction->setProcess('AccountPayable');
			/* Current Liabilities - Sales Vat & Tax */
			$transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(16));
			$transaction->setAmount('-'.$amount);
			$transaction->setCredit($amount);
			$this->_em->persist($transaction);
			$this->_em->flush();

		}

	}


    public function tallySalesTransaction(\Appstore\Bundle\TallyBundle\Entity\Sales $entity,$accountSales)
    {
        $this->insertTallySalesItem($entity,$accountSales);
        $this->insertTallySalesCash($entity,$accountSales);
        $this->insertTallySalesAccountReceivable($entity,$accountSales);
        $this->insertTallySalesVatAccountPayable($entity,$accountSales);
    }

    private function insertTallySalesItem(\Appstore\Bundle\TallyBundle\Entity\Sales $entity , AccountSales $accountSales)
    {
        $amount =  $entity->getNetTotal();
        $transaction = new Transaction();
        $transaction->setGlobalOption($accountSales->getGlobalOption());
        if(!empty($accountSales->getBranches())){
            $transaction->setBranches($accountSales->getBranches());
        }
        $transaction->setAccountRefNo($accountSales->getAccountRefNo());
        $transaction->setProcessHead('Sales');
        $transaction->setProcess('Goods');
        /* Sales Revenue - Sales goods account */
        $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(6));
        $transaction->setAmount('-'.$amount);
        $transaction->setCredit($amount);
        $this->_em->persist($transaction);
        $this->_em->flush();

    }

    private function insertTallySalesCash(\Appstore\Bundle\TallyBundle\Entity\Sales $entity , AccountSales $accountSales)
    {
        $amount = $entity->getPayment();
        if($amount > 0) {
            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setUpdated($entity->getUpdated());

            /* Cash - Cash various */
            if($accountSales->getTransactionMethod()->getId() == 2 ){
                /* Current Asset Bank Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(3));
                if($accountSales->getAccountBank()){
                    $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertBankAccount($accountSales->getAccountBank());
                    $transaction->setSubAccountHead($subAccount);
                }
                $transaction->setProcess('Current Assets');
            }elseif($accountSales->getTransactionMethod()->getId() == 3 ){
                /* Current Asset Mobile Account Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(10));
                if($accountSales->getAccountMobileBank()){
                    $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertMobileBankAccount($accountSales->getAccountMobileBank());
                    $transaction->setSubAccountHead($subAccount);
                }
                $transaction->setProcess('Current Assets');
            }else{
                /* Cash - Cash Debit */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(30));
                $transaction->setProcess('Cash');
            }

            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();
        }
    }

    private function insertTallySalesAccountReceivable(\Appstore\Bundle\TallyBundle\Entity\Sales $entity, AccountSales $accountSales)
    {

        $amount = ($entity->getNetTotal() - $entity->getPayment());
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setProcess('AccountReceivable');
            /* Assets Account - Account Receivable */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(4));
            $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertCustomerAccount($entity->getCustomer());
            $transaction->setSubAccountHead($subAccount);
            $transaction->setAmount($amount);
            $transaction->setDebit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }

    }

    private function insertTallySalesVatAccountPayable(\Appstore\Bundle\TallyBundle\Entity\Sales $entity, AccountSales $accountSales)
    {

        $amount = $entity->getTotalTaxIncidence();
        if($amount > 0){

            $transaction = new Transaction();
            $transaction->setGlobalOption($accountSales->getGlobalOption());
            if(!empty($accountSales->getBranches())){
                $transaction->setBranches($accountSales->getBranches());
            }
            $transaction->setAccountRefNo($accountSales->getAccountRefNo());
            $transaction->setProcessHead('Sales');
            $transaction->setProcess('AccountPayable');
            /* Current Liabilities - Sales Vat & Tax */
            $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find(16));
            $transaction->setAmount('-'.$amount);
            $transaction->setCredit($amount);
            $this->_em->persist($transaction);
            $this->_em->flush();

        }

    }

    public function itemDistributionTransaction($purchase,$accountPurchase,$source='')
    {
        $this->insertPurchaseCash($purchase,$accountPurchase);
        $this->insertPurchaseAccountPayable($purchase,$accountPurchase);
        $this->insertFixedAssets($purchase,$accountPurchase);
        $this->insertPurchaseExpense($purchase,$accountPurchase);
    }

    public function insertFixedAssets(\Appstore\Bundle\AssetsBundle\Entity\Purchase $purchase,$accountPurchase)
    {
        /* @var $item PurchaseItem */

        foreach ($purchase->getPurchaseItems() as $item) {
            if($item->getItem()->getProductType() == "Assets"){
                $accountHead = $item->getItem()->getCategory()->getAccountHead();
                $transaction = new Transaction();
                $transaction->setGlobalOption($accountPurchase->getGlobalOption());
                $transaction->setAccountRefNo($accountPurchase->getAccountRefNo());
                $transaction->setProcessHead('Assets');
                $transaction->setProcess('Depreciation');
                /* Assets Account - Capital Assets */
                $transaction->setAccountHead($this->_em->getRepository('AccountingBundle:AccountHead')->find($accountHead));
                $subAccount = $this->_em->getRepository('AccountingBundle:AccountHead')->insertCapitalAssetsAccount($accountPurchase->getGlobalOption(),$item);
                $transaction->setSubAccountHead($subAccount);
                $transaction->setAmount($item->getSubTotal());
                $transaction->setDebit($item->getSubTotal());
                $this->_em->persist($transaction);
                $this->_em->flush();
            }

        }

    }

    public function insertPurchaseExpense(\Appstore\Bundle\AssetsBundle\Entity\Purchase $purchase)
    {

    }


}
