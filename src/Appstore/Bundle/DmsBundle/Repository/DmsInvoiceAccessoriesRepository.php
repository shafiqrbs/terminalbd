<?php

namespace Appstore\Bundle\DmsBundle\Repository;
use Appstore\Bundle\DmsBundle\Controller\InvoiceController;
use Appstore\Bundle\DmsBundle\Entity\AdmissionPatientDmsParticular;
use Appstore\Bundle\DmsBundle\Entity\DmsConfig;
use Appstore\Bundle\DmsBundle\Entity\DmsInvoice;
use Appstore\Bundle\DmsBundle\Entity\DmsInvoiceAccessories;
use Appstore\Bundle\DmsBundle\Entity\DmsInvoiceMedicine;
use Appstore\Bundle\DmsBundle\Entity\Invoice;
use Appstore\Bundle\DmsBundle\Entity\InvoiceDmsParticular;
use Appstore\Bundle\DmsBundle\Entity\DmsParticular;
use Core\UserBundle\Entity\User;
use Doctrine\ORM\EntityRepository;
use Setting\Bundle\ToolBundle\Entity\GlobalOption;


/**
 * DmsInvoiceParticularRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class DmsInvoiceAccessoriesRepository extends EntityRepository
{


    public function insertInvoiceAccessories(DmsInvoice $invoice, $data)
    {

        $em = $this->_em;
        $entity = new DmsInvoiceAccessories();
        $quantity = !empty($data['quantity']) ? $data['quantity'] :1;
        $entity->setQuantity($quantity);
        $accessoriesId = $data['accessories'];
        $accessories = $em->getRepository('DmsBundle:DmsParticular')->find($accessoriesId);
        $entity->setDmsParticular($accessories);
        $entity->setSubTotal($quantity * $accessories->getPrice());
        $entity->setPrice($accessories->getPrice());
        $entity->setDmsInvoice($invoice);
        $em->persist($entity);
        $em->flush();
    }


    public function getInvoiceAccessories(DmsInvoice $sales)
    {
        $entities = $sales->getDmsInvoiceAccessories();
        $data = '';
        $date = '';
        $i = 1;
        /** @var $entity DmsInvoiceAccessories */
        foreach ($entities as $entity) {

            $data .= '<tr id="accessories-'.$entity->getId().'">';
            $data .= '<td class="numeric" >' . $i . '</td>';
            $data .= '<td class="numeric" >' . $entity->getUpdated()->format('d-m-Y') . '</td>';
            $data .= '<td class="numeric" >' . $entity->getDmsParticular()->getParticularCode().' - '.$entity->getDmsParticular()->getName(). '</td>';
            $data .= '<td class="numeric" >' . $entity->getQuantity(). '</td>';
            $data .= '<td class="numeric" >' . $entity->getPrice(). '</td>';
            $data .= '<td class="numeric" >' . $entity->getPrice() * $entity->getQuantity(). '</td>';
            $data .= '<td class="numeric" id="approved-'.$entity->getId().'" >
            <a id="'.$entity->getId().'" data-id="'.$entity->getId().'"  data-url="/dms/invoice/'. $entity->getId(). '/accessories-approved" href="javascript:" class="btn blue mini approveAccessories" >Approve</a>
            <a id="'.$entity->getId().'" data-id="'.$entity->getId().'"  data-url="/dms/invoice/'. $entity->getId(). '/accessories-delete" href="javascript:" class="btn red mini deleteAccessories" ><i class="icon-trash"></i></a>
            </td>';
            $data .= '</tr>';
            $i++;
        }
        return $data;
    }

}
