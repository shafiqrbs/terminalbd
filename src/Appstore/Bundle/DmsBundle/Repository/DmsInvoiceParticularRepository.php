<?php

namespace Appstore\Bundle\DmsBundle\Repository;
use Appstore\Bundle\DmsBundle\Controller\InvoiceController;
use Appstore\Bundle\DmsBundle\Entity\AdmissionPatientDmsParticular;
use Appstore\Bundle\DmsBundle\Entity\DmsInvoice;
use Appstore\Bundle\DmsBundle\Entity\DmsInvoiceParticular;
use Appstore\Bundle\DmsBundle\Entity\Invoice;
use Appstore\Bundle\DmsBundle\Entity\InvoiceDmsParticular;
use Appstore\Bundle\DmsBundle\Entity\DmsParticular;
use Core\UserBundle\Entity\User;
use Doctrine\ORM\EntityRepository;
use Setting\Bundle\ToolBundle\Entity\GlobalOption;


/**
 * DmsInvoiceParticularRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class DmsInvoiceParticularRepository extends EntityRepository
{

    public function handleDateRangeFind($qb,$data)
    {
        if(empty($data)){
            $datetime = new \DateTime("now");
            $data['startDate'] = $datetime->format('Y-m-d 00:00:00');
            $data['endDate'] = $datetime->format('Y-m-d 23:59:59');
        }else{
            $data['startDate'] = date('Y-m-d',strtotime($data['startDate']));
            $data['endDate'] = date('Y-m-d',strtotime($data['endDate']));
        }

        if (!empty($data['startDate']) ) {
            $qb->andWhere("e.created >= :startDate");
            $qb->setParameter('startDate', $data['startDate'].' 00:00:00');
        }
        if (!empty($data['endDate'])) {
            $qb->andWhere("e.created <= :endDate");
            $qb->setParameter('endDate', $data['endDate'].' 23:59:59');
        }
    }

    public function invoicePathologicalReportLists(User $user , $mode , $data)
    {
        $hospital = $user->getGlobalOption()->getDmsConfig()->getId();
        $qb = $this->createQueryBuilder('ip');
        $qb->join('ip.dmsInvoice','e');
        $qb->join('ip.particular','p');
        $qb->where('e.hospitalConfig = :hospital')->setParameter('hospital', $hospital) ;
        $qb->andWhere('p.service = :service')->setParameter('service', 1) ;
       // $this->handleSearchBetween($qb,$data);
        $qb->andWhere("e.process IN (:process)");
        $qb->setParameter('process', array('Done','Paid','In-progress','Diagnostic','Admitted'));
        $qb->orderBy('e.created','DESC');
        $qb->getQuery();
        return  $qb;
    }

    public function insertInvoiceParticularSingle(DmsInvoice $invoice, $data)
    {
        $em = $this->_em;
        $service = $this->_em->getRepository('DmsBundle:DmsService')->findOneBy(array('slug'=>$data['service']));
        $position = !empty($data['position']) ? $data['position'] : '' ;
        $teethNo = !empty($data['teethNo']) ? $data['teethNo'] : '' ;
        $explode = explode(',',$teethNo);
        $entity = new DmsInvoiceParticular();
        $entity->setDmsService($service);
        $entity->setMetaValue($data['procedure']);
        $entity->setTeethPosition($position);
        $entity->setTeethNo($explode);
        $entity->setDmsInvoice($invoice);
        $em->persist($entity);
        $em->flush();

    }

    public function insertInvoiceParticularReturn(DmsInvoice $invoice, $data)
    {
        $em = $this->_em;
        $service = $this->_em->getRepository('DmsBundle:DmsService')->findOneBy(array('slug'=>$data['service']));
        $invoiceParticulars = $this->findBy(array('dmsInvoice'=>$invoice,'dmsService'=>$service ));
        $data ='';
        foreach ($invoiceParticulars as $invoiceParticular ):
        $colSpan = empty($invoiceParticular->getTeethPosition()) ? 'colspan="2"':'';
        $data .='<tr id="remove-'.$invoiceParticular->getId().'">';
        $data .='<td  class="numeric"'.$colSpan.'>'.$invoiceParticular->getMetaValue().'</td>';
        if (!empty($invoiceParticular->getMetaValue())) {
            $data .= '<td class="numeric">';
            $data .='<table class="dms-table">';
            $leftTeeths = [8,7,6,5,4,3,2,1];
            $rightTeeths = [1,2,3,4,5,6,7,8];
            $data .='<tr>';
            $data .='<td class="dms-td dms-td-border-none dms-td-border-bottom">';
            $data .='<ul class="leftTeeth">';
                       foreach ($leftTeeths as $left) :
                            $selected = (!empty($invoiceParticular->getTeethNo()) and in_array($left,$invoiceParticular->getTeethNo()) and  $invoiceParticular->getTeethPosition() == 'upper-left') ? 'class="active"' : '';
                            $data .='<li '.$selected.'>'.$left.'</li>';
                       endforeach;
                    $data .='</ul>';
                $data .='</td>';
            $data .='<td class="dms-td dms-td-border-bottom">';
            $data .='<ul class="rightTeeth">';
            foreach ($rightTeeths as $right) :
                $selected = (!empty($invoiceParticular->getTeethNo()) and in_array($right,$invoiceParticular->getTeethNo()) and  $invoiceParticular->getTeethPosition() == 'upper-right') ? 'class="active"' : '';
                $data .='<li '.$selected.'>'.$right.'</li>';
            endforeach;
            $data .='</ul>';
            $data .='</td>';
            $data .= '</tr>';
            $data .='<tr>';
            $data .='<td class="dms-td dms-td-border-none dms-td-border-bottom">';
            $data .='<ul class="leftTeeth">';
            foreach ($leftTeeths as $left) :
                $selected = (!empty($invoiceParticular->getTeethNo()) and in_array($left,$invoiceParticular->getTeethNo()) and  $invoiceParticular->getTeethPosition() == 'lower-left') ? 'class="active"' : '';
                $data .='<li '.$selected.'>'.$left.'</li>';
            endforeach;
            $data .='</ul>';
            $data .='</td>';
            $data .='<td class="dms-td dms-td-border-bottom">';
            $data .='<ul class="rightTeeth">';
            foreach ($rightTeeths as $right) :
                $selected = (!empty($invoiceParticular->getTeethNo()) and in_array($right,$invoiceParticular->getTeethNo()) and  $invoiceParticular->getTeethPosition() == 'lower-right') ? 'class="active"' : '';
                $data .='<li '.$selected.'>'.$right.'</li>';
            endforeach;
            $data .='</ul>';
            $data .='</td>';
            $data .= '</tr>';
            $data .= '</table>';
            $data .= '</td>';
        }
        $data .='<td class="numeric">';
        $data .='<a href="javascript:" class="btn red mini particularDelete" data-id="'. $invoiceParticular->getId().'" id="'. $invoiceParticular->getId().'" data-url="/dms/invoice/'.$invoice->getInvoice().'/'.$invoiceParticular->getId().'/particular-delete" ><i class="icon-trash"></i></a>';
        $data .='</td>';
        $data .='</tr>';

        endforeach;

        return $data;
    }


    public function insertInvoiceItems(DmsInvoice $invoice, $data)
    {
        $em = $this->_em;
        if(!empty($data['metaKey'])) {
            foreach ($data['metaKey'] as $key => $val) {
                $particular = $this->_em->getRepository('DmsBundle:DmsParticular')->find($val);
                $entity = new DmsInvoiceParticular();
                $invoiceDmsParticular = $this->_em->getRepository('DmsBundle:DmsInvoiceParticular')->findOneBy(array('dmsInvoice' => $invoice, 'dmsParticular' => $particular));
                if (!empty($invoiceDmsParticular)) {
                    $entity->setMetaValue($data['metaValue'][$key]);
                } else {
                    $entity->setDmsParticular($particular);
                    $entity->setMetaValue($data['metaValue'][$key]);
                }
                $entity->setDmsParticular($particular);
                $entity->setDmsInvoice($invoice);
                $em->persist($entity);
                $em->flush();
            }
        }

    }

    public function getSalesItems(DmsInvoice $sales)
    {
        $entities = $sales->getDmsInvoiceParticulars();
        $data = '';
        $i = 1;
        foreach ($entities as $entity) {
            $data .= '<tr id="remove-'. $entity->getId() . '">';
            $data .= '<td class="span1"><span class="badge badge-warning toggle badge-custom" id='. $entity->getId() .'" ><span>[+]</span></span></td>';
            $data .= '<td class="span1" >' . $i . '</td>';
            $data .= '<td class="span1" >' . $entity->getDmsParticular()->getDmsParticularCode() . '</td>';
            $data .= '<td class="span4" >' . $entity->getDmsParticular()->getName() . '</td>';
            $data .= '<td class="span2" >' . $entity->getDmsParticular()->getService()->getName() . '</td>';
            $data .= '<td class="span1" >' . $entity->getQuantity() . '</td>';
            $data .= '<td class="span2" >' . $entity->getSalesPrice() . '</td>';
            $data .= '<td class="span2" >' . $entity->getSubTotal() . '</td>';
            $data .= '<td class="span1" >
            <a id="'.$entity->getId().'" data-id="'.$entity->getId().'" title="Are you sure went to delete ?" data-url="/dms/invoice/' . $sales->getId() . '/' . $entity->getId() . '/particular-delete" href="javascript:" class="btn red mini particularDelete" ><i class="icon-trash"></i></a>
            </td>';
            $data .= '</tr>';
            $i++;
        }
        return $data;
    }

    public function invoiceDmsParticularLists($user){


    }

    public function dmsInvoiceParticularReverse(Invoice $invoice)
    {

        $em = $this->_em;

        /** @var InvoiceDmsParticular $item */

        foreach($invoice->getDmsInvoiceParticulars() as $item ){

            /** @var DmsParticular  $particular */

            $particular = $item->getDmsParticular();
            if( $particular->getService()->getId() == 4 ){
                $qnt = ($particular->getSalesQuantity() - $item->getQuantity());
                $particular->setSalesQuantity($qnt);
                $em->persist($particular);
                $em->flush();
            }
        }

    }

    public function getLastCode($entity,$datetime)
    {

        $today_startdatetime = $datetime->format('Y-m-d 00:00:00');
        $today_enddatetime = $datetime->format('Y-m-d 23:59:59');


        $qb = $this->createQueryBuilder('ip');
        $qb
            ->select('MAX(ip.code)')
            ->join('ip.dmsInvoice','s')
            ->where('s.hospitalConfig = :hospital')
            ->andWhere('s.updated >= :today_startdatetime')
            ->andWhere('s.updated <= :today_enddatetime')
            ->setParameter('hospital', $entity->getDmsConfig())
            ->setParameter('today_startdatetime', $today_startdatetime)
            ->setParameter('today_enddatetime', $today_enddatetime);
        $lastCode = $qb->getQuery()->getSingleScalarResult();

        if (empty($lastCode)) {
            return 0;
        }

        return $lastCode;
    }


    public function reportSalesAccessories(GlobalOption $option ,$data)
    {
        $startDate = isset($data['startDate'])  ? $data['startDate'] : '';
        $endDate =   isset($data['endDate'])  ? $data['endDate'] : '';
        $qb = $this->createQueryBuilder('ip');
        $qb->join('ip.particular','p');
        $qb->join('ip.dmsInvoice','i');
        $qb->select('SUM(ip.quantity * p.purchasePrice ) AS totalPurchaseAmount');
        $qb->where('i.hospitalConfig = :hospital');
        $qb->setParameter('hospital', $option->getDmsConfig());
        $qb->andWhere("i.process IN (:process)");
        $qb->setParameter('process', array('Done','Paid','In-progress','Diagnostic','Admitted','Release','Death','Released','Dead'));
        if (!empty($data['startDate']) ) {
            $qb->andWhere("i.updated >= :startDate");
            $qb->setParameter('startDate', $startDate.' 00:00:00');
        }
        if (!empty($data['endDate'])) {
            $qb->andWhere("i.updated <= :endDate");
            $qb->setParameter('endDate', $endDate.' 23:59:59');
        }
        $res = $qb->getQuery()->getOneOrNullResult();
        return $res['totalPurchaseAmount'];

    }

    public function serviceDmsParticularDetails(User $user, $data)
    {

        $hospital = $user->getGlobalOption()->getDmsConfig()->getId();
        $startDate = isset($data['startDate'])  ? $data['startDate'] : '';
        $endDate =   isset($data['endDate'])  ? $data['endDate'] : '';
        if(!empty($data['service'])){

            $qb = $this->createQueryBuilder('ip');
            $qb->leftJoin('ip.particular','p');
            $qb->leftJoin('ip.dmsInvoice','e');
            $qb->select('SUM(ip.quantity) AS totalQuantity');
            $qb->addSelect('SUM(ip.quantity * p.purchasePrice ) AS purchaseAmount');
            $qb->addSelect('SUM(ip.quantity * ip.salesPrice ) AS salesAmount');
            $qb->addSelect('p.name AS serviceName');
            $qb->where('e.hospitalConfig = :hospital');
            $qb->setParameter('hospital', $hospital);
            $qb->andWhere('p.service = :service');
            $qb->setParameter('service', $data['service']);
            $qb->andWhere("e.process IN (:process)");
            $qb->setParameter('process', array('Done','Paid','In-progress','Diagnostic','Admitted','Release','Death'));
            $this->handleDateRangeFind($qb,$data);
            $qb->groupBy('p.id');
            $res = $qb->getQuery()->getArrayResult();
            return $res;

        }else{

            return false;
        }

    }
}
