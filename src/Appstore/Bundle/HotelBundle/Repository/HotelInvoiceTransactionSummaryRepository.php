<?php

namespace Appstore\Bundle\HotelBundle\Repository;
use Appstore\Bundle\AccountingBundle\Entity\AccountSales;
use Appstore\Bundle\HotelBundle\Entity\HotelInvoice;
use Appstore\Bundle\HotelBundle\Entity\HotelInvoiceTransaction;
use Appstore\Bundle\HotelBundle\Entity\HotelInvoiceTransactionSummary;
use Core\UserBundle\Entity\User;
use Doctrine\ORM\EntityRepository;


/**
 * HotelHotelInvoiceTransactionRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class HotelInvoiceTransactionSummaryRepository extends EntityRepository
{

	public function insertTransactionSummary(HotelInvoice $invoice)
	{
		$entity = new HotelInvoiceTransactionSummary();
		$entity->setHotelInvoice($invoice);
		$entity->setHotelConfig($invoice->getHotelConfig());
		$entity->setDiscount(0);
		$entity->setVat(0);
		$entity->setServiceCharge(0);
		$entity->setSubTotal(0);
		$entity->setTotal(0);
		$entity->setReceived(0);
		$entity->setDue(0);
		$this->_em->persist($entity);
		$this->_em->flush();
	}

	public function updateTransactionSummary(HotelInvoice $invoice)
	{

		/* @var $entity HotelInvoiceTransactionSummary */

		$entity = $this->findOneBy(array('hotelConfig' => $invoice->getHotelConfig(),'hotelInvoice'=> $invoice));
		$em = $this->_em;
		$res = $em->createQueryBuilder()
		          ->from('HotelBundle:HotelInvoiceTransaction','si')
		          ->join('si.hotelInvoice','e')
		          ->select('sum(si.discount) as discount , sum(si.vat) as vat, sum(si.serviceCharge) as serviceCharge , sum(si.subTotal) as subTotal , sum(si.total) as total, sum(si.received) as received')
		          ->where('si.referenceInvoice = :invoice')
		          ->setParameter('invoice', $invoice->getId())
		          ->andWhere('e.hotelConfig = :config')
		          ->setParameter('config', $invoice->getHotelConfig()->getId())
		          ->andWhere('si.process = :process')
		          ->setParameter('process', 'Done')
		          ->getQuery()->getOneOrNullResult();

		$discount = !empty($res['discount']) ? $res['discount'] : 0 ;
		$vat = !empty($res['vat']) ? $res['vat'] : 0 ;
		$charge = !empty($res['serviceCharge']) ? $res['serviceCharge'] : 0 ;
		$subTotal = !empty($res['subTotal']) ? $res['subTotal'] : 0 ;
		$total = !empty($res['total']) ? $res['total'] : 0 ;
		$received = !empty($res['received']) ? $res['received'] : 0 ;
		$due = ($total - ($received + $discount));

		$entity->setDiscount($discount);
		$entity->setVat(floatval($vat));
		$entity->setServiceCharge(floatval($charge));
		$entity->setSubTotal($subTotal);
		$entity->setTotal($total - $discount);
		$entity->setReceived($received);
		$entity->setDue($due);
		$em->flush();

	}

}