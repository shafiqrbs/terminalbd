<?php

namespace Appstore\Bundle\HumanResourceBundle\Repository;
use Appstore\Bundle\HumanResourceBundle\Entity\EmployeePayroll;
use Core\UserBundle\Entity\User;
use Setting\Bundle\ToolBundle\Entity\GlobalOption;

/**
 * LeavePolicyRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class EmployeePayrollRepository extends \Doctrine\ORM\EntityRepository
{
    public function getPayrollEmployee($option)
    {

        $qb = $this->createQueryBuilder('e');
        $qb->join('e.employee','u');
        $qb->join('u.profile','p');
        $qb->leftJoin('p.designation','d');
        $qb->select('e.id as id');
        $qb->addSelect('d.name as designationName');
        $qb->addSelect('p.name as name','p.mobile as mobile','p.joiningDate');
        $qb->andWhere("e.globalOption =".$option);
        $qb->andWhere('e.domainOwner = 2');
        $qb->andWhere('e.isDelete != 1');
        $qb->orderBy("p.name","ASC");
        $result = $qb->getQuery()->getResult();
        return $result;


    }

    public function userInsertUpdate(User $user)
    {

        $em = $this->_em;
        if($user->getEmployeePayroll()){

            return $user->getEmployeePayroll();

        }else{

            $entity = new EmployeePayroll();
            $entity->setEmployee($user);
            $entity->setGlobalOption($user->getGlobalOption());
            $entity->setEmployeeName($user->getProfile()->getName());
            $em->persist($entity);
            $em->flush();
            return $entity;
        }

    }
}
