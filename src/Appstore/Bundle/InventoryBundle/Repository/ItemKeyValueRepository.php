<?php

namespace Appstore\Bundle\InventoryBundle\Repository;
use Appstore\Bundle\InventoryBundle\Entity\ItemKeyValue;
use Appstore\Bundle\InventoryBundle\Entity\ItemMetaAttribute;
use Appstore\Bundle\InventoryBundle\Entity\PurchaseVendorItem;
use Doctrine\ORM\EntityRepository;

/**
 * ItemKeyValueRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ItemKeyValueRepository extends EntityRepository
{
    public function insertItemKeyValue(PurchaseVendorItem $reEntity,$data)
    {

        $em = $this->_em;
        $i=0;

        if(isset($data['metaValue'])){
            foreach ($data['metaValue'] as $value) {
                $metaId = isset($data['metaId'][$i]) ? $data['metaId'][$i] : 0 ;
                $itemKeyValue = $this->_em->getRepository('InventoryBundle:ItemKeyValue')->findOneBy(array('purchaseVendorItem'=>$reEntity,'id' => $metaId));
                if(!empty($metaId)){
                    $this->updateMetaAttribute($itemKeyValue,$data['metaKey'][$i],$data['metaValue'][$i]);
                }else{
                    if(isset($data['metaValue'][$i]) and !empty($data['metaValue'][$i]))
                    {
                        $entity = new ItemKeyValue();
                        $entity->setMetaKey($data['metaKey'][$i]);
                        $entity->setMetaValue($data['metaValue'][$i]);
                        $entity->setPurchaseVendorItem($reEntity);
                        $em->persist($entity);
                    }

                }

                $i++;
            }
            $em->flush();
        }


    }

    public function updateMetaAttribute(ItemKeyValue $itemKeyValue,$key,$value)
    {
            $em = $this->_em;
            $itemKeyValue->setMetaKey($key);
            $itemKeyValue->setMetaValue($value);
            $em->flush();
    }

}
