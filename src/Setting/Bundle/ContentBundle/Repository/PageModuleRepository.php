<?php

namespace Setting\Bundle\ContentBundle\Repository;
use Doctrine\ORM\EntityRepository;
use Setting\Bundle\ContentBundle\Entity\PageModule;

/**
 * TeamRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class PageModuleRepository extends EntityRepository
{
    public function createFeatureModule($page,$data)
    {
        $this->remove($page);
        if(isset($data['module']) and !empty( $data['module']) ){

            $i = 0;
            foreach( $data['module'] as $row ){

               if(isset($data['module'][$i]) and !empty( $data['module'][$i]) ) {

                    $moduleId = $data['module'][$i];
                    $module = $this->_em->getRepository('SettingToolBundle:Module')->find($moduleId);
                    $entity = new PageModule();
                    $entity->setName($data['name'][$i]);
                    $entity->setShowLimit($data['showLimit'][$i]);
                    $entity->setShowColumn($data['column'][$i]);
                    $entity->setPage($page);
                    $entity->setModule($module);
                    $this->_em->persist($entity);

                }
                $i++;
            }
            $this->_em->flush();
        }
    }

    public function createHomeFeatureModule($page,$data)
    {
        $this->removeHome($page);
        if(isset($data['module']) and !empty( $data['module']) ){

            $i = 0;
            foreach( $data['module'] as $row ){

               if(isset($data['module'][$i]) and !empty( $data['module'][$i]) ) {

                    $moduleId = $data['module'][$i];
                    $module = $this->_em->getRepository('SettingToolBundle:Module')->find($moduleId);
                    $entity = new PageModule();
                    $entity->setName($data['name'][$i]);
                    $entity->setShowLimit($data['showLimit'][$i]);
                    $entity->setColumn($data['column'][$i]);
                    $entity->setHomePage($page);
                    $entity->setModule($module);
                    $this->_em->persist($entity);

                }
                $i++;
            }
            $this->_em->flush();
        }
    }

    private  function remove($page)
    {

        $em =$this->_em;
        $entities = $em->getRepository('SettingContentBundle:PageModule')->findBy(array('page'=>$page));
        foreach ($entities as $entity )
        {
            $em->remove($entity);
        }
        $em->flush();


    }
    private  function removeHome($page)
    {

        $em =$this->_em;
        $entities = $em->getRepository('SettingContentBundle:PageModule')->findBy(array('homePage'=>$page));
        foreach ($entities as $entity )
        {
            $em->remove($entity);
        }
        $em->flush();


    }
}

